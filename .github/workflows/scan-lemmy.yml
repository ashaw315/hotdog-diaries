name: Smart Scan Lemmy (Threshold-Based)

on:
  schedule:
    - cron: '0 5,13,21 * * *'  # 3 times daily - prioritized for underrepresented platform
  workflow_dispatch:
    inputs:
      force_override:
        description: 'Force scan even if thresholds met'
        required: false
        default: 'false'
        type: boolean
      max_posts:
        description: 'Maximum posts to scan'
        required: false
        default: '30'
        type: string

jobs:
  smart-scan-lemmy:
    runs-on: ubuntu-latest
    steps:
      - name: Smart Threshold Check and Scan
        run: |
          echo "üåê Smart scanning Lemmy (underrepresented platform priority)..."

          FORCE_OVERRIDE="${{ github.event.inputs.force_override || 'false' }}"
          MAX_POSTS="${{ github.event.inputs.max_posts || '30' }}"
          
          echo "üîß Parameters: force_override=$FORCE_OVERRIDE, max_posts=$MAX_POSTS"
          echo "üéØ Note: Lemmy is an underrepresented platform - lower thresholds apply"
          
          RESULT=$(curl -L -X POST "${{ secrets.SITE_URL }}/api/admin/smart-scan" \
            -H "Authorization: Bearer ${{ secrets.AUTH_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"platform\": \"lemmy\",
              \"forceOverride\": $FORCE_OVERRIDE,
              \"maxPosts\": $MAX_POSTS
            }" \
            --silent --show-error --retry 2 --retry-delay 5)
          
          if [ $? -eq 0 ]; then
            SKIPPED=$(echo "$RESULT" | jq -r '.skipped // false')
            SCANNED=$(echo "$RESULT" | jq -r '.scanned // false')
            REASON=$(echo "$RESULT" | jq -r '.reason // "unknown"')
            
            if [ "$SKIPPED" = "true" ]; then
              READY_TO_POST=$(echo "$RESULT" | jq -r '.currentStats.readyToPost // 0')
              APPROVED=$(echo "$RESULT" | jq -r '.currentStats.approved // 0')
              echo "‚è≠Ô∏è Lemmy scan SKIPPED: $REASON"
              echo "üìä Current content: $READY_TO_POST ready to post, $APPROVED approved"
              echo "‚úÖ Rare for Lemmy - content levels unexpectedly high!"
            elif [ "$SCANNED" = "true" ]; then
              FOUND=$(echo "$RESULT" | jq -r '.scanResult.data.totalFound // 0')
              PROCESSED=$(echo "$RESULT" | jq -r '.scanResult.data.processed // 0')
              echo "‚úÖ Lemmy scan COMPLETED: $REASON"
              echo "üìà Results: Found $FOUND, processed $PROCESSED new posts"
              echo "üéØ Lemmy scanning prioritized due to underrepresentation"
            else
              echo "‚ùì Unexpected response from smart scan"
              echo "$RESULT" | jq -r '.message // "No message"'
            fi
          else
            echo "‚ö†Ô∏è Smart scan check failed (continuing - Lemmy issues are common)"
          fi
          
          echo "‚úÖ Lemmy smart scan attempt completed"
      
      - name: Handle Scan Issues
        if: failure()
        run: |
          echo "‚ö†Ô∏è Smart Lemmy scan failed - this is expected occasionally"
          echo "üí° Lemmy instances can be unreliable - threshold-based scanning helps optimize attempts"