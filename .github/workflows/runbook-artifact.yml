name: ðŸ“‹ Generate Runbook Artifacts

on:
  push:
    branches: [ main ]
    paths: 
      - 'docs/runbook.md'
      - 'scripts/md-to-pdf.ts'
      - '.github/workflows/runbook-artifact.yml'
  
  workflow_dispatch:
    inputs:
      force_regenerate:
        description: 'Force regenerate all artifacts'
        required: false
        type: boolean
        default: false

jobs:
  generate-runbook-artifacts:
    name: ðŸ”„ Generate PDF and Upload Artifacts
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      actions: write
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“‹ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'
          
      - name: ðŸ“¦ Install dependencies
        run: |
          ppnpm install
          # Install additional system dependencies for PDF generation
          sudo apt-get update
          sudo apt-get install -y fonts-liberation fonts-dejavu-core
          
      - name: ðŸ“„ Generate PDF from Markdown
        run: |
          echo "ðŸ”„ Generating runbook PDF..."
          npm run runbook:pdf
          
          # Verify PDF was generated
          if [ ! -f "docs/runbook.pdf" ]; then
            echo "âŒ PDF generation failed"
            exit 1
          fi
          
          # Get file size for logging
          PDF_SIZE=$(du -h docs/runbook.pdf | cut -f1)
          echo "âœ… PDF generated successfully ($PDF_SIZE)"
          
      - name: ðŸ“Š Generate metadata
        run: |
          echo "ðŸ“Š Generating artifact metadata..."
          
          cat > docs/runbook-metadata.json << EOF
          {
            "generated_at": "$(date -u -Iseconds)",
            "git_commit": "${{ github.sha }}",
            "git_ref": "${{ github.ref }}",
            "workflow_run_id": "${{ github.run_id }}",
            "workflow_run_number": "${{ github.run_number }}",
            "triggered_by": "${{ github.event_name }}",
            "actor": "${{ github.actor }}",
            "repository": "${{ github.repository }}",
            "pdf_size_bytes": $(stat -c%s docs/runbook.pdf),
            "pdf_checksum_sha256": "$(sha256sum docs/runbook.pdf | cut -d' ' -f1)",
            "source_files": [
              "docs/runbook.md",
              "scripts/md-to-pdf.ts"
            ],
            "format_version": "1.0.0"
          }
          EOF
          
          echo "âœ… Metadata generated"
          cat docs/runbook-metadata.json
          
      - name: ðŸ” Validate artifacts
        run: |
          echo "ðŸ” Validating generated artifacts..."
          
          # Check PDF is valid (basic validation)
          if file docs/runbook.pdf | grep -q "PDF"; then
            echo "âœ… PDF format validated"
          else
            echo "âŒ Invalid PDF format"
            exit 1
          fi
          
          # Check metadata is valid JSON
          if jq . docs/runbook-metadata.json > /dev/null; then
            echo "âœ… Metadata JSON validated"
          else
            echo "âŒ Invalid metadata JSON"
            exit 1
          fi
          
          # Check file sizes are reasonable
          PDF_SIZE_BYTES=$(stat -c%s docs/runbook.pdf)
          if [ $PDF_SIZE_BYTES -lt 10000 ]; then
            echo "âŒ PDF suspiciously small ($PDF_SIZE_BYTES bytes)"
            exit 1
          elif [ $PDF_SIZE_BYTES -gt 50000000 ]; then
            echo "âŒ PDF suspiciously large ($PDF_SIZE_BYTES bytes)"
            exit 1
          else
            echo "âœ… PDF size reasonable ($PDF_SIZE_BYTES bytes)"
          fi
          
      - name: ðŸ“¤ Upload runbook artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sre-runbook-${{ github.run_number }}
          path: |
            docs/runbook.pdf
            docs/runbook.md
            docs/runbook-metadata.json
          retention-days: 90
          compression-level: 6
          
      - name: ðŸ“¤ Upload latest runbook (overwrites)
        uses: actions/upload-artifact@v4
        with:
          name: sre-runbook-latest
          path: |
            docs/runbook.pdf
            docs/runbook.md
            docs/runbook-metadata.json
          retention-days: 365
          compression-level: 6
          
      - name: ðŸ“‹ Generate summary
        run: |
          echo "## ðŸ“‹ Runbook Artifacts Generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Generated at:** $(date -u -Iseconds)" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“„ Generated Files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| File | Size | SHA256 |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| \`docs/runbook.pdf\` | $(du -h docs/runbook.pdf | cut -f1) | \`$(sha256sum docs/runbook.pdf | cut -d' ' -f1 | head -c16)...\` |" >> $GITHUB_STEP_SUMMARY
          echo "| \`docs/runbook.md\` | $(du -h docs/runbook.md | cut -f1) | \`$(sha256sum docs/runbook.md | cut -d' ' -f1 | head -c16)...\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¤ Artifact Downloads" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Versioned:** \`sre-runbook-${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Latest:** \`sre-runbook-latest\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All artifacts generated successfully!" >> $GITHUB_STEP_SUMMARY
          
      - name: âœ… Complete
        run: |
          echo "ðŸŽ‰ Runbook artifact generation completed successfully!"
          echo ""
          echo "ðŸ“¦ Artifacts available:"
          echo "  - sre-runbook-${{ github.run_number }} (versioned)"
          echo "  - sre-runbook-latest (always current)"
          echo ""
          echo "ðŸ“„ Generated files:"
          ls -la docs/runbook.*