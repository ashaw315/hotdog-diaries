"use strict";exports.id=4749,exports.ids=[4749],exports.modules={84749:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.d(b,{f:()=>o});var e=c(6901),f=c(76865),g=c(29159),h=c(40704),i=c(23292),j=c(55229),k=c(7462),l=c(35144),m=a([e,f,g,h,i,j,k]);[e,f,g,h,i,j,k]=m.then?(await m)():m;class n{constructor(){this.isScanning=!1,this.tiktokService=new e.M,this.filteringService=new f.G,this.contentProcessor=new g.Q,this.duplicateDetection=new h.Y}async startAutomatedScanning(){try{let a=await this.getScanConfig();if(!a.isEnabled)return void await (0,k.rP)(l.$b.INFO,"TIKTOK_SCAN_DISABLED","TikTok scanning is disabled in configuration");if(!(await this.tiktokService.getApiStatus()).isAuthenticated)return void await (0,k.rP)(l.$b.WARNING,"TIKTOK_NOT_AUTHENTICATED","TikTok scanning cannot start: not authenticated");this.scanTimer&&clearInterval(this.scanTimer);let b=60*a.scanInterval*1e3;this.scanTimer=setInterval(async()=>{this.isScanning||await this.performScan()},b),await this.performScan(),await (0,k.rP)(l.$b.INFO,"TIKTOK_SCAN_STARTED",`TikTok scanning started with ${a.scanInterval} minute intervals`,{config:a})}catch(a){throw await (0,k.rP)(l.$b.ERROR,"TIKTOK_SCAN_START_ERROR",`Failed to start TikTok scanning: ${a.message}`,{error:a.message}),a}}async stopAutomatedScanning(){this.scanTimer&&(clearInterval(this.scanTimer),this.scanTimer=void 0),await (0,k.rP)(l.$b.INFO,"TIKTOK_SCAN_STOPPED","TikTok scanning stopped")}async performScan(){if(this.isScanning)throw Error("TikTok scan already in progress");this.isScanning=!0;let a=`tiktok_scan_${Date.now()}`,b=new Date,c={scanId:a,startTime:b,endTime:new Date,videosFound:0,videosProcessed:0,videosApproved:0,videosRejected:0,videosFlagged:0,duplicatesFound:0,errors:[],rateLimitHit:!1,keywordsScanned:[],hashtagsScanned:[]};try{let b=await this.getScanConfig();if(!b.isEnabled)throw Error("TikTok scanning is disabled");if(!(await this.tiktokService.getApiStatus()).isAuthenticated)throw Error("TikTok not authenticated");let d=[],e=[...b.targetKeywords,...b.targetHashtags];c.keywordsScanned=b.targetKeywords,c.hashtagsScanned=b.targetHashtags;try{let c={keywords:e,limit:b.maxVideosPerScan,minViews:b.minViews,sortBy:b.sortBy,publishedAfter:new Date(Date.now()-6048e5)},f=await this.tiktokService.searchVideos(c);d=d.concat(f),await (0,k.rP)(l.$b.INFO,"TIKTOK_SEARCH_SUCCESS",`Found ${f.length} TikTok videos for search terms: ${e.join(", ")}`,{scanId:a,searchTerms:e,videosFound:f.length})}catch(b){c.errors.push(`Search failed: ${b.message}`),(b.message.includes("rate limit")||b.message.includes("quota"))&&(c.rateLimitHit=!0),await (0,k.rP)(l.$b.ERROR,"TIKTOK_SEARCH_ERROR",`TikTok search failed: ${b.message}`,{scanId:a,searchTerms:e,error:b.message})}c.videosFound=d.length;let f=this.removeDuplicateVideos(d);c.duplicatesFound=d.length-f.length;let g=f.filter(a=>!b.maxDuration||a.duration<=b.maxDuration);if(g.length>0){let a=g.reduce((a,b)=>b.viewCount+b.likeCount>a.viewCount+a.likeCount?b:a);c.highestEngagedVideo={id:a.id,title:a.title.substring(0,100)+"...",viewCount:a.viewCount,username:a.username}}for(let b of g)try{let d=await this.processTikTokVideo(b,a);switch(c.videosProcessed++,d.status){case"approved":c.videosApproved++;break;case"rejected":c.videosRejected++;break;case"flagged":c.videosFlagged++}}catch(d){c.errors.push(`Video ${b.id} processing failed: ${d.message}`),await (0,k.rP)(l.$b.ERROR,"TIKTOK_VIDEO_PROCESS_ERROR",`Failed to process TikTok video ${b.id}: ${d.message}`,{scanId:a,videoId:b.id,error:d.message})}return await this.updateLastScanTime(),c.endTime=new Date,c.nextScanTime=new Date(Date.now()+60*b.scanInterval*1e3),await this.recordScanResult(c),await (0,k.rP)(l.$b.INFO,"TIKTOK_SCAN_COMPLETED",`TikTok scan completed: ${c.videosProcessed} processed, ${c.videosApproved} approved`,c),await i.W.recordScanCompletion(c.videosProcessed,!0,c.errors),c}catch(b){throw c.errors.push(b.message),c.endTime=new Date,await (0,k.rP)(l.$b.ERROR,"TIKTOK_SCAN_ERROR",`TikTok scan failed: ${b.message}`,{scanId:a,error:b.message}),await i.W.recordScanCompletion(c.videosProcessed,!1,c.errors),b}finally{this.isScanning=!1}}async processTikTokVideo(a,b){try{if(!await this.tiktokService.validateTikTokContent(a))return{status:"rejected"};let c=`${a.title} ${a.description}`.trim(),d=await this.duplicateDetection.generateContentHash(c);if(await this.duplicateDetection.checkForDuplicates({content_text:c,content_video_url:a.videoUrl,content_image_url:a.thumbnailUrl,content_hash:d}))return{status:"rejected"};let e=this.determineContentType(a),f={content_text:c,content_video_url:a.videoUrl,content_image_url:a.thumbnailUrl,content_type:e,source_platform:"tiktok",original_url:a.webUrl,original_author:`@${a.username}`,scraped_at:new Date,content_hash:d,tiktok_data:JSON.stringify({video_id:a.id,username:a.username,user_display_name:a.userDisplayName,user_id:a.userId,created_at:a.createdAt,duration:a.duration,view_count:a.viewCount,like_count:a.likeCount,share_count:a.shareCount,comment_count:a.commentCount,hashtags:a.hashtags,effects:a.effects,sounds:a.sounds,is_commercial:a.isCommercial,region:a.region,scan_id:b})},g=await (0,j.Yr)("content_queue").values(f).returning(["id"]).first();if(!g)throw Error("Failed to insert content into queue");return{status:(await this.contentProcessor.processContent(g.id)).action}}catch(c){throw await (0,k.rP)(l.$b.ERROR,"TIKTOK_VIDEO_PROCESS_ERROR",`Failed to process TikTok video ${a.id}: ${c.message}`,{videoId:a.id,scanId:b,error:c.message,video:{title:a.title.substring(0,100),username:a.username,viewCount:a.viewCount}}),c}}determineContentType(a){let b=a.title.trim().length>0||a.description.trim().length>0;return a.videoUrl?b?"mixed":"video":a.thumbnailUrl?b?"mixed":"image":"text"}removeDuplicateVideos(a){let b=new Set;return a.filter(a=>!b.has(a.id)&&(b.add(a.id),!0))}async getScanConfig(){try{let a=await (0,j.P)("tiktok_scan_config").select("*").first();if(!a)return{isEnabled:!1,scanInterval:120,maxVideosPerScan:20,targetKeywords:this.tiktokService.getHotdogKeywords().slice(0,5),targetHashtags:this.tiktokService.getFoodHashtags().slice(0,5),minViews:100,maxDuration:180,sortBy:"relevance"};return{isEnabled:a.is_enabled,scanInterval:a.scan_interval,maxVideosPerScan:a.max_videos_per_scan,targetKeywords:a.target_keywords||this.tiktokService.getHotdogKeywords().slice(0,5),targetHashtags:a.target_hashtags||this.tiktokService.getFoodHashtags().slice(0,5),minViews:a.min_views,maxDuration:a.max_duration,sortBy:a.sort_by||"relevance",lastScanId:a.last_scan_id,lastScanTime:a.last_scan_time?new Date(a.last_scan_time):void 0}}catch(a){return{isEnabled:!1,scanInterval:120,maxVideosPerScan:20,targetKeywords:this.tiktokService.getHotdogKeywords().slice(0,5),targetHashtags:this.tiktokService.getFoodHashtags().slice(0,5),minViews:100,maxDuration:180,sortBy:"relevance"}}}async updateScanConfig(a){try{let b={...await this.getScanConfig(),...a};await (0,j.P)("tiktok_scan_config").upsert({is_enabled:b.isEnabled,scan_interval:b.scanInterval,max_videos_per_scan:b.maxVideosPerScan,target_keywords:b.targetKeywords,target_hashtags:b.targetHashtags,min_views:b.minViews,max_duration:b.maxDuration,sort_by:b.sortBy,last_scan_id:b.lastScanId,last_scan_time:b.lastScanTime,updated_at:new Date}),await (0,k.rP)(l.$b.INFO,"TIKTOK_CONFIG_UPDATED","TikTok scan configuration updated",{config:b})}catch(b){throw await (0,k.rP)(l.$b.ERROR,"TIKTOK_CONFIG_UPDATE_ERROR",`Failed to update TikTok configuration: ${b.message}`,{config:a,error:b.message}),b}}async updateLastScanTime(){await this.updateScanConfig({lastScanTime:new Date})}async recordScanResult(a){try{await (0,j.Yr)("tiktok_scan_results").values({scan_id:a.scanId,start_time:a.startTime,end_time:a.endTime,videos_found:a.videosFound,videos_processed:a.videosProcessed,videos_approved:a.videosApproved,videos_rejected:a.videosRejected,videos_flagged:a.videosFlagged,duplicates_found:a.duplicatesFound,keywords_scanned:a.keywordsScanned,hashtags_scanned:a.hashtagsScanned,highest_views:a.highestEngagedVideo?.viewCount||0,errors:a.errors,rate_limit_hit:a.rateLimitHit,created_at:new Date})}catch(b){await (0,k.rP)(l.$b.WARNING,"TIKTOK_SCAN_RESULT_RECORD_ERROR",`Failed to record TikTok scan result: ${b.message}`,{scanId:a.scanId,error:b.message})}}async getScanStats(){try{let a=await (0,j.P)("tiktok_scan_results").select(["COUNT(*) as total_scans","SUM(videos_found) as total_videos_found","SUM(videos_processed) as total_videos_processed","SUM(videos_approved) as total_videos_approved","AVG(highest_views) as average_views","MAX(end_time) as last_scan_time"]).first(),b=await this.getScanConfig(),c=b.lastScanTime?new Date(b.lastScanTime.getTime()+60*b.scanInterval*1e3):void 0,d=parseInt(a?.total_scans||"0"),e=parseInt(a?.total_videos_processed||"0"),f=parseInt(a?.total_videos_approved||"0");return{totalScans:d,totalVideosFound:parseInt(a?.total_videos_found||"0"),totalVideosProcessed:e,totalVideosApproved:f,averageViews:parseFloat(a?.average_views||"0"),averageDuration:60,topKeywords:[],topHashtags:[],topCreators:[],scanFrequency:b.scanInterval,lastScanTime:a?.last_scan_time?new Date(a.last_scan_time):void 0,nextScanTime:c,successRate:e>0?f/e*100:0}}catch(a){return{totalScans:0,totalVideosFound:0,totalVideosProcessed:0,totalVideosApproved:0,averageViews:0,averageDuration:0,topKeywords:[],topHashtags:[],topCreators:[],scanFrequency:120,lastScanTime:void 0,nextScanTime:void 0,successRate:0}}}async testConnection(){try{let a=await this.tiktokService.getApiStatus();if(a.isAuthenticated)return{success:!0,message:"TikTok API connection successful",details:a};return{success:!1,message:a.lastError||"TikTok not authenticated",details:a}}catch(a){return{success:!1,message:`Connection test failed: ${a.message}`,details:{error:a.message}}}}}let o=new n;d()}catch(a){d(a)}})}};