"use strict";exports.id=467,exports.ids=[467],exports.modules={1366:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.d(b,{O:()=>j});var e=c(7462),f=c(35144),g=c(55229),h=a([e,g]);[e,g]=h.then?(await h)():h;class i{static{this.ERROR_RATE_THRESHOLD=15}static{this.LATENCY_THRESHOLD=8e3}static{this.RATE_LIMIT_WARNING_THRESHOLD=70}static{this.TOKEN_EXPIRY_WARNING_DAYS=7}async getHealthMetrics(){try{let a=await (0,g.P)("system_logs").select(["log_level","message","created_at"]).where("component","like","INSTAGRAM_%").where("created_at",">=",new Date(Date.now()-36e5)).orderBy("created_at","desc").limit(100),b=await this.determineAuthenticationStatus(),c=this.determineRateLimitStatus(a),d=await this.determineScanStatus(),e=this.calculateErrorRate(a),f=await this.calculateAverageResponseTime(),h=await this.getLastSuccessfulScan(),i=await this.calculateUptime(),j=this.countRecentAlerts(),k=await this.getTokenExpiryDate();return{authenticationStatus:b,rateLimitStatus:c,scanStatus:d,errorRate:e,averageResponseTime:f,lastSuccessfulScan:h,uptime:i,alertsTriggered:j,tokenExpiry:k}}catch(a){return await (0,e.rP)(f.$b.ERROR,"INSTAGRAM_HEALTH_CHECK_ERROR",`Failed to get Instagram health metrics: ${a.message}`,{error:a.message}),{authenticationStatus:"critical",rateLimitStatus:"warning",scanStatus:"error",errorRate:100,averageResponseTime:0,uptime:0,alertsTriggered:1}}}async recordApiRequest(a,b,c){try{this.metrics.requestsPerHour++,a?this.metrics.averageLatency=(this.metrics.averageLatency+b)/2:c&&(this.metrics.errorsByType[c]=(this.metrics.errorsByType[c]||0)+1),this.metrics.peakLatency=Math.max(this.metrics.peakLatency,b),await this.checkPerformanceThresholds(a,b,c),b>i.LATENCY_THRESHOLD&&await (0,e.rP)(f.$b.WARNING,"INSTAGRAM_HIGH_LATENCY",`Instagram API request took ${b}ms`,{latency:b,success:a,errorType:c})}catch(a){console.error("Failed to record Instagram API request:",a)}}async recordRateLimitHit(a){try{this.metrics.rateLimitHits++,await this.triggerAlert({type:"rate_limit",severity:"medium",message:`Instagram API rate limit exceeded. Reset at ${a.toISOString()}`,metadata:{resetTime:a.toISOString()}})}catch(a){console.error("Failed to record Instagram rate limit hit:",a)}}async recordTokenRefresh(a,b){try{this.metrics.authenticationRefreshes++,a&&b?await (0,e.rP)(f.$b.INFO,"INSTAGRAM_TOKEN_REFRESH_SUCCESS","Instagram access token refreshed successfully",{newExpiryDate:b}):await this.triggerAlert({type:"auth_error",severity:"high",message:"Instagram token refresh failed",metadata:{success:a}})}catch(a){console.error("Failed to record Instagram token refresh:",a)}}async recordScanCompletion(a,b,c){try{b&&(this.metrics.postsProcessedPerHour+=a),(!b||c.length>0)&&await this.triggerAlert({type:"scan_failure",severity:c.length>3?"high":"medium",message:`Instagram scan completed with ${c.length} errors`,metadata:{postsProcessed:a,errors:c.slice(0,3)}})}catch(a){console.error("Failed to record Instagram scan completion:",a)}}async checkTokenExpiry(){try{let a=await this.getTokenExpiryDate();if(a){let b=(a.getTime()-Date.now())/864e5;b<=i.TOKEN_EXPIRY_WARNING_DAYS&&await this.triggerAlert({type:"token_expiry",severity:b<=1?"critical":"high",message:`Instagram token expires in ${Math.ceil(b)} days`,metadata:{expiryDate:a.toISOString(),daysUntilExpiry:Math.ceil(b)}})}}catch(a){console.error("Failed to check Instagram token expiry:",a)}}getPerformanceMetrics(){return{...this.metrics}}getActiveAlerts(){return this.alerts.filter(a=>!a.resolved)}async resolveAlert(a){let b=this.alerts.find(b=>b.id===a);b&&(b.resolved=!0,b.resolvedAt=new Date,await (0,e.rP)(f.$b.INFO,"INSTAGRAM_ALERT_RESOLVED",`Instagram alert resolved: ${b.message}`,{alertId:a,alertType:b.type}))}resetMetrics(){this.metrics={requestsPerHour:0,successRate:0,averageLatency:0,peakLatency:0,errorsByType:{},rateLimitHits:0,postsProcessedPerHour:0,authenticationRefreshes:0};let a=new Date(Date.now()-864e5);this.alerts=this.alerts.filter(b=>!b.resolved||b.resolvedAt&&b.resolvedAt>a)}async determineAuthenticationStatus(){try{let a=await (0,g.P)("instagram_auth").select(["expires_at","is_active"]).where("is_active",!0).orderBy("created_at","desc").first();if(!a)return"critical";let b=(new Date(a.expires_at).getTime()-Date.now())/864e5;if(b<=1)return"critical";if(b<=7)return"warning";return"healthy"}catch(a){return"critical"}}determineRateLimitStatus(a){let b=a.filter(a=>a.message.toLowerCase().includes("rate limit"));return b.length>3?"critical":b.length>1?"warning":"healthy"}async determineScanStatus(){try{let a=await (0,g.P)("instagram_scan_config").select(["is_enabled","last_scan_time"]).first();if(!a||!a.is_enabled)return"paused";if(a.last_scan_time){let b=new Date(a.last_scan_time),c=new Date(Date.now()-108e5);if(b<c)return"error"}return"active"}catch(a){return"error"}}calculateErrorRate(a){let b=a.length;if(0===b)return 0;let c=a.filter(a=>"error"===a.log_level);return Math.round(c.length/b*100)}async calculateAverageResponseTime(){return this.metrics.averageLatency}async getLastSuccessfulScan(){try{let a=await (0,g.P)("instagram_scan_results").select(["end_time"]).where("posts_approved",">",0).orderBy("end_time","desc").first();return a?new Date(a.end_time):void 0}catch(a){return}}async calculateUptime(){try{let a=new Date(Date.now()-864e5),b=await (0,g.P)("system_logs").count("*").where("log_level","error").where("component","like","INSTAGRAM_%").where("created_at",">=",a).first(),c=parseInt(b?.count||"0"),d=Math.max(0,(96-c)/96*100);return Math.round(d)}catch(a){return 0}}async getTokenExpiryDate(){try{let a=await (0,g.P)("instagram_auth").select(["expires_at"]).where("is_active",!0).orderBy("created_at","desc").first();return a?new Date(a.expires_at):void 0}catch(a){return}}countRecentAlerts(){let a=new Date(Date.now()-36e5);return this.alerts.filter(b=>b.timestamp>a).length}async checkPerformanceThresholds(a,b,c){let d=this.calculateCurrentErrorRate();d>i.ERROR_RATE_THRESHOLD&&await this.triggerAlert({type:"high_error_rate",severity:"high",message:`Instagram API error rate is ${d}%`,metadata:{errorRate:d}}),b>i.LATENCY_THRESHOLD&&await this.triggerAlert({type:"api_error",severity:"medium",message:`Instagram API latency is high: ${b}ms`,metadata:{latency:b}})}calculateCurrentErrorRate(){let a=this.metrics.requestsPerHour,b=Object.values(this.metrics.errorsByType).reduce((a,b)=>a+b,0);return a>0?Math.round(b/a*100):0}async triggerAlert(a){if(this.alerts.find(b=>b.type===a.type&&!b.resolved&&Date.now()-b.timestamp.getTime()<36e5))return;let b={id:`instagram_alert_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,timestamp:new Date,resolved:!1,...a};this.alerts.push(b),await (0,e.rP)("critical"===a.severity?f.$b.FATAL:"high"===a.severity?f.$b.ERROR:"medium"===a.severity?f.$b.WARN:f.$b.INFO,"INSTAGRAM_ALERT_TRIGGERED",b.message,{alertId:b.id,alertType:b.type,severity:b.severity,metadata:b.metadata})}constructor(){this.alerts=[],this.metrics={requestsPerHour:0,successRate:0,averageLatency:0,peakLatency:0,errorsByType:{},rateLimitHits:0,postsProcessedPerHour:0,authenticationRefreshes:0}}}let j=new i;d()}catch(a){d(a)}})},67993:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.d(b,{L:()=>i});var e=c(93785),f=c(99986),g=c(73790),h=a([e,f,g]);[e,f,g]=h.then?(await h)():h;class i extends e.P{constructor(a){super({rateLimitMs:9e4,...a}),this.baseUrl="https://www.instagram.com",this.hashtags=["hotdog","hotdogs","hotdoglovers","foodporn"]}async scrapeContent(a,b=20){let c=Date.now(),d=a||this.getRandomHashtag(),e=`instagram_${d}_${b}`;try{let a=this.getCachedData(e,6e5);if(a)return await f.RE.logDebug("InstagramScraper","Returning cached data",{hashtag:d,count:a.length}),{success:!0,data:a,timestamp:new Date,url:`${this.baseUrl}/explore/tags/${d}/`,responseTime:Date.now()-c};await f.RE.logInfo("InstagramScraper","Starting Instagram scraping",{hashtag:d,limit:b});let h=await this.createPage(),i=`${this.baseUrl}/explore/tags/${d}/`,j=await this.navigateWithRetry(h,i);if(!j.success)return await h.close(),{success:!1,error:j.error,timestamp:new Date,url:i,responseTime:Date.now()-c};await h.waitForTimeout(3e3);let k=(await this.extractPosts(h,b)).map(a=>this.convertToScrapedContent(a));return this.setCachedData(e,k),await h.close(),await g.z.recordCustomMetric("instagram_scraping_success",Date.now()-c,"ms",{hashtag:d,postsFound:k.length.toString(),requestedLimit:b.toString()}),await f.RE.logInfo("InstagramScraper","Instagram scraping completed",{hashtag:d,postsFound:k.length,responseTime:Date.now()-c}),{success:!0,data:k,timestamp:new Date,url:i,responseTime:Date.now()-c}}catch(a){return await f.RE.logError("InstagramScraper","Instagram scraping failed",{hashtag:d,error:a.message},a),await g.z.recordCustomMetric("instagram_scraping_failed",Date.now()-c,"ms",{hashtag:d,error:a.message}),{success:!1,error:a.message,timestamp:new Date,url:`${this.baseUrl}/explore/tags/${d}/`,responseTime:Date.now()-c}}}async extractPosts(a,b){let c=[];try{await a.waitForSelector("article",{timeout:1e4}),await this.scrollToLoadContent(a,b);let d=await a.evaluate(a=>{let b=[],c=document.querySelectorAll('article a[href*="/p/"]');for(let d=0;d<Math.min(c.length,a);d++){let a=c[d],e=a.querySelector("img"),f=a.getAttribute("href");if(!e||!f)continue;let g=f.match(/\/p\/([^\/]+)/)?.[1];if(!g)continue;let h=e.getAttribute("alt")||"",i=h.length>10?h:"Instagram hotdog post",j=a.closest("article")?.querySelector('a[href*="/"]'),k=j?.getAttribute("href")?.match(/\/([^\/]+)\//),l=k?.[1]||"unknown";b.push({id:g,shortcode:g,media_url:e.src,thumbnail_url:e.src,caption:i,author:{username:l,profile_url:`https://www.instagram.com/${l}/`},post_url:`https://www.instagram.com${f}`,hashtags:this.extractHashtagsFromText(i),is_video:!1,timestamp:new Date})}return b},b);c.push(...d)}catch(a){await f.RE.logWarning("InstagramScraper","Error extracting posts",{error:a.message})}return c}async scrollToLoadContent(a,b){let c=0,d=0;for(;d<5&&!(await a.evaluate(()=>document.querySelectorAll('article a[href*="/p/"]').length)>=b);){await a.evaluate(()=>{window.scrollTo(0,document.body.scrollHeight)}),await a.waitForTimeout(2e3);let b=await a.evaluate(()=>document.body.scrollHeight);b===c?d++:d=0,c=b}}convertToScrapedContent(a){return{id:a.id,platform:"instagram",type:a.is_video?"video":"image",content_image_url:a.is_video?void 0:a.media_url,content_video_url:a.is_video?a.media_url:void 0,content_text:a.caption,original_url:a.post_url,original_author:a.author.username,original_author_url:a.author.profile_url,scraped_at:new Date,metadata:{likes:a.likes_count,comments:a.comments_count,hashtags:a.hashtags,thumbnail_url:a.thumbnail_url,shortcode:a.shortcode,is_video:a.is_video,timestamp:a.timestamp}}}extractHashtagsFromText(a){return(a.match(/#[\w\u00c0-\u024f\u1e00-\u1eff]+/gi)||[]).map(a=>a.substring(1).toLowerCase())}getRandomHashtag(){return this.hashtags[Math.floor(Math.random()*this.hashtags.length)]}async testAccess(){try{let a=await this.createPage(),b=await this.navigateWithRetry(a,`${this.baseUrl}/explore/tags/hotdog/`);return await a.close(),{accessible:b.success,error:b.error}}catch(a){return{accessible:!1,error:a.message}}}getAvailableHashtags(){return[...this.hashtags]}getInstagramStats(){return{...this.getStats(),availableHashtags:this.hashtags,rateLimitMs:this.config.rateLimitMs}}}d()}catch(a){d(a)}})},90467:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.d(b,{E:()=>m,g:()=>l});var e=c(7462),f=c(35144),g=c(1366),h=c(67993),i=c(99986),j=c(73790),k=a([e,g,h,i,j]);[e,g,h,i,j]=k.then?(await k)():k;class l{static{this.API_BASE_URL="https://graph.instagram.com"}static{this.BASIC_DISPLAY_URL="https://api.instagram.com"}static{this.RATE_LIMIT_PER_HOUR=200}constructor(){this.rateLimitTracker={used:0,remaining:200,resetTime:new Date(Date.now()+36e5)},this.accessToken=null,this.tokenExpiresAt=null,this.accessToken=process.env.INSTAGRAM_ACCESS_TOKEN||null,process.env.INSTAGRAM_TOKEN_EXPIRES_AT&&(this.tokenExpiresAt=new Date(process.env.INSTAGRAM_TOKEN_EXPIRES_AT)),this.scraper=new h.L({headless:!0,rateLimitMs:9e4}),this.useWebScraping="true"!==process.env.INSTAGRAM_USE_API}async searchHashtags(a){let b=Date.now();try{let c=a.hashtag.replace("#",""),d=Math.min(a.limit||25,50),h=[];if(this.useWebScraping){await i.RE.logInfo("InstagramService","Using web scraping for hashtag search",{hashtag:c,limit:d});let b=await this.scraper.scrapeContent(c,d);if(!b.success)throw Error(`Web scraping failed: ${b.error}`);for(let c of b.data||[]){let b=await this.convertScrapedToProcessed(c);a.minLikes&&b.likesCount<a.minLikes||await this.validateInstagramContent(b)&&h.push(b)}await i.RE.logInfo("InstagramService","Web scraping search completed",{hashtag:c,scraped:b.data?.length||0,processed:h.length,responseTime:b.responseTime})}else{if(!this.accessToken)throw Error("Instagram access token not available. Please authenticate first.");for(let b of(await this.checkRateLimit(),await this.checkTokenExpiration(),await this.getUserMedia(d)))if(this.containsHashtag(b.caption,c)||this.isHotdogRelated(b.caption)){let c=await this.processInstagramMedia(b);if(a.minLikes&&c.likesCount<a.minLikes)continue;h.push(c)}this.updateRateLimit()}await (0,e.rP)(f.$b.INFO,"INSTAGRAM_HASHTAG_SEARCH_SUCCESS",`Found ${h.length} Instagram posts for hashtag #${c}`,{hashtag:c,mediaFound:h.length,limit:d,method:this.useWebScraping?"scraping":"api"});let k=Date.now()-b;return await g.O.recordApiRequest(!0,k),await j.z.recordAPIMetric("instagram","search_hashtags",k,200),h}catch(h){let c=Date.now()-b,d=h.message.includes("rate limit")?"rate_limit":h.message.includes("token")?"auth_error":h.message.includes("scraping")?"scraping_error":"api_error";throw await g.O.recordApiRequest(!1,c,d),await j.z.recordAPIMetric("instagram","search_hashtags",c,500),h.message.includes("rate limit")&&await g.O.recordRateLimitHit(this.rateLimitTracker.resetTime),await (0,e.rP)(f.$b.ERROR,"INSTAGRAM_HASHTAG_SEARCH_ERROR",`Instagram hashtag search failed: ${h.message}`,{hashtag:a.hashtag,error:h.message,method:this.useWebScraping?"scraping":"api"}),Error(`Instagram hashtag search failed: ${h.message}`)}}async getMediaInfo(a){try{if(!this.accessToken)throw Error("Instagram access token not available");await this.checkRateLimit(),await this.checkTokenExpiration();let b=await fetch(`${l.API_BASE_URL}/${a}?fields=id,caption,media_type,media_url,thumbnail_url,permalink,timestamp,username,like_count,comments_count&access_token=${this.accessToken}`,{method:"GET",headers:{Accept:"application/json"}});if(!b.ok){let a=await b.json().catch(()=>({}));throw Error(`Instagram API error: ${b.status} - ${a.error?.message||b.statusText}`)}let c=await b.json();return this.updateRateLimit(),this.processInstagramMedia(c)}catch(b){throw await (0,e.rP)(f.$b.ERROR,"INSTAGRAM_MEDIA_INFO_ERROR",`Failed to get Instagram media info: ${b.message}`,{mediaId:a,error:b.message}),b}}async processInstagramMedia(a){try{let b=this.extractHashtags(a.caption||""),c=this.extractMentions(a.caption||""),d=[];return"CAROUSEL_ALBUM"===a.media_type&&a.children&&(d=await this.getCarouselChildren(a.id)),{id:a.id,caption:a.caption||"",mediaType:a.media_type,mediaUrl:a.media_url,thumbnailUrl:a.thumbnail_url,permalink:a.permalink,username:a.username||"unknown",userId:a.user?.id||a.owner?.id||"unknown",timestamp:new Date(a.timestamp),likesCount:a.like_count||0,commentsCount:a.comments_count||0,hashtags:b,mentions:c,location:a.location?{id:a.location.id,name:a.location.name}:void 0,isStory:"STORY"===a.media_product_type,carouselMedia:d.length>0?d:void 0}}catch(b){throw await (0,e.rP)(f.$b.ERROR,"INSTAGRAM_MEDIA_PROCESS_ERROR",`Failed to process Instagram media: ${b.message}`,{mediaId:a.id,error:b.message}),b}}async handleInstagramAuth(a,b){try{let c=process.env.INSTAGRAM_CLIENT_ID,d=process.env.INSTAGRAM_CLIENT_SECRET;if(!c||!d)throw Error("Instagram client credentials not configured");let g=await fetch(`${l.BASIC_DISPLAY_URL}/oauth/access_token`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({client_id:c,client_secret:d,grant_type:"authorization_code",redirect_uri:b,code:a})});if(!g.ok){let a=await g.json().catch(()=>({}));throw Error(`Token exchange failed: ${a.error_message||g.statusText}`)}let h=await g.json(),i=await fetch(`${l.API_BASE_URL}/access_token?grant_type=ig_exchange_token&client_secret=${d}&access_token=${h.access_token}`,{method:"GET"});if(!i.ok){let a=await i.json().catch(()=>({}));throw Error(`Long-lived token exchange failed: ${a.error?.message||i.statusText}`)}let j=await i.json(),k={accessToken:j.access_token,expiresAt:new Date(Date.now()+1e3*j.expires_in),scope:h.scope?.split(",")||["user_profile","user_media"],userId:h.user_id};return this.accessToken=k.accessToken,this.tokenExpiresAt=k.expiresAt,await (0,e.rP)(f.$b.INFO,"INSTAGRAM_AUTH_SUCCESS","Instagram authentication completed successfully",{userId:k.userId,expiresAt:k.expiresAt}),k}catch(a){throw await (0,e.rP)(f.$b.ERROR,"INSTAGRAM_AUTH_ERROR",`Instagram authentication failed: ${a.message}`,{error:a.message}),a}}async refreshAccessToken(){try{if(!this.accessToken)throw Error("No access token to refresh");let a=await fetch(`${l.API_BASE_URL}/refresh_access_token?grant_type=ig_refresh_token&access_token=${this.accessToken}`,{method:"GET"});if(!a.ok){let b=await a.json().catch(()=>({}));throw Error(`Token refresh failed: ${b.error?.message||a.statusText}`)}let b=await a.json();this.accessToken=b.access_token,this.tokenExpiresAt=new Date(Date.now()+1e3*b.expires_in),await (0,e.rP)(f.$b.INFO,"INSTAGRAM_TOKEN_REFRESHED","Instagram access token refreshed successfully",{expiresAt:this.tokenExpiresAt}),await g.O.recordTokenRefresh(!0,this.tokenExpiresAt)}catch(a){throw await g.O.recordTokenRefresh(!1),await (0,e.rP)(f.$b.ERROR,"INSTAGRAM_TOKEN_REFRESH_ERROR",`Failed to refresh Instagram access token: ${a.message}`,{error:a.message}),a}}async getApiStatus(){try{let a=!1;if(!this.useWebScraping)return this.accessToken&&this.tokenExpiresAt&&(a=(await fetch(`${l.API_BASE_URL}/me?fields=id,username&access_token=${this.accessToken}`,{method:"GET"})).ok,this.updateRateLimit()),{isAuthenticated:a,rateLimits:this.rateLimitTracker,tokenExpiresAt:this.tokenExpiresAt||void 0,lastRequest:new Date};{let b=await this.scraper.testAccess();return{isAuthenticated:a=b.accessible,rateLimits:{used:0,remaining:999,resetTime:new Date(Date.now()+36e5)},lastRequest:new Date,lastError:b.error}}}catch(a){return{isAuthenticated:!1,rateLimits:{used:0,remaining:0,resetTime:new Date},lastError:a.message,lastRequest:new Date}}}getHotdogHashtags(){return["hotdog","hotdogs","hotdoglovers","hotdoglunch","hotdogday","hotdoglife","hotdogtime","hotdogstand","frankfurter","wiener","sausage","bratwurst","ballparkfrank","chilidog","corndog","foodporn","grilling","bbq","barbecue","grilledhotdog","ballparkfood","streetfood","fastfood","americanfood"]}async validateInstagramContent(a){try{let b=a.caption.toLowerCase(),c=["hotdog","hot dog","hotdogs","hot dogs","frankfurter","wiener","bratwurst","sausage","chili dog","corn dog","ballpark frank"].some(a=>b.includes(a)),d=a.hashtags.some(a=>this.getHotdogHashtags().includes(a.toLowerCase()));if(!c&&!d||["buy now","click link","dm me","link in bio","promo code","discount","sale","affiliate"].some(a=>b.includes(a)))return!1;let e=a.likesCount>10||a.commentsCount>2;return a.mediaUrl&&a.mediaUrl.length>0||e}catch(b){return await (0,e.rP)(f.$b.ERROR,"INSTAGRAM_VALIDATION_ERROR",`Instagram content validation failed: ${b.message}`,{mediaId:a.id,error:b.message}),!1}}async convertScrapedToProcessed(a){try{let b=a.metadata?.hashtags||this.extractHashtags(a.content_text),c=this.extractMentions(a.content_text);return{id:a.id,caption:a.content_text||"",mediaType:"video"===a.type?"VIDEO":"IMAGE",mediaUrl:a.content_image_url||a.content_video_url||"",thumbnailUrl:a.metadata?.thumbnail_url,permalink:a.original_url,username:a.original_author,userId:a.original_author,timestamp:a.scraped_at,likesCount:a.metadata?.likes||0,commentsCount:a.metadata?.comments||0,hashtags:b,mentions:c,location:void 0,isStory:!1,carouselMedia:void 0}}catch(b){throw await i.RE.logError("InstagramService","Failed to convert scraped content",{scrapedId:a.id,error:b.message},b),b}}async getUserMedia(a=25){if(!this.accessToken)throw Error("No access token available");let b=await fetch(`${l.API_BASE_URL}/me/media?fields=id,caption,media_type,media_url,thumbnail_url,permalink,timestamp,username,like_count,comments_count&limit=${a}&access_token=${this.accessToken}`,{method:"GET"});if(!b.ok){let a=await b.json().catch(()=>({}));throw Error(`Failed to get user media: ${a.error?.message||b.statusText}`)}return(await b.json()).data||[]}async getCarouselChildren(a){if(!this.accessToken)return[];try{let b=await fetch(`${l.API_BASE_URL}/${a}/children?fields=id,media_type,media_url&access_token=${this.accessToken}`,{method:"GET"});if(!b.ok)return[];return(await b.json()).data||[]}catch(a){return[]}}extractHashtags(a){return(a.match(/#[a-zA-Z0-9_]+/g)||[]).map(a=>a.substring(1))}extractMentions(a){return(a.match(/@[a-zA-Z0-9_.]+/g)||[]).map(a=>a.substring(1))}containsHashtag(a,b){return a.toLowerCase().includes(`#${b.toLowerCase()}`)}isHotdogRelated(a){let b=a.toLowerCase();return["hotdog","hot dog","frankfurter","wiener","bratwurst","sausage","chili dog","corn dog","ballpark frank"].some(a=>b.includes(a))}async checkRateLimit(){let a=new Date;if(a>=this.rateLimitTracker.resetTime&&(this.rateLimitTracker.used=0,this.rateLimitTracker.remaining=l.RATE_LIMIT_PER_HOUR,this.rateLimitTracker.resetTime=new Date(a.getTime()+36e5)),this.rateLimitTracker.remaining<=0){let b=this.rateLimitTracker.resetTime.getTime()-a.getTime();throw Error(`Instagram API rate limit exceeded. Reset in ${Math.ceil(b/1e3)} seconds`)}}async checkTokenExpiration(){if(!this.tokenExpiresAt)return;let a=new Date;this.tokenExpiresAt.getTime()-a.getTime()<6048e5&&await this.refreshAccessToken()}updateRateLimit(){this.rateLimitTracker.used++,this.rateLimitTracker.remaining=Math.max(0,l.RATE_LIMIT_PER_HOUR-this.rateLimitTracker.used)}async cleanup(){this.useWebScraping&&this.scraper&&await this.scraper.cleanup()}getServiceStats(){return this.useWebScraping?{mode:"web_scraping",scraper_stats:this.scraper.getInstagramStats(),rate_limits:this.rateLimitTracker}:{mode:"api",rate_limits:this.rateLimitTracker,token_expires_at:this.tokenExpiresAt}}}let m=new l;d()}catch(a){d(a)}})}};