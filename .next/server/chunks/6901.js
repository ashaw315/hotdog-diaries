"use strict";exports.id=6901,exports.ids=[6901],exports.modules={6901:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.d(b,{M:()=>l,u:()=>m});var e=c(7462),f=c(35144),g=c(23292),h=c(75905),i=c(99986),j=c(73790),k=a([e,g,h,i,j]);[e,g,h,i,j]=k.then?(await k)():k;class l{static{this.API_BASE_URL="https://open.tiktokapis.com"}static{this.AUTH_URL="https://www.tiktok.com/v2/auth/authorize"}static{this.TOKEN_URL="https://open.tiktokapis.com/v2/oauth/token"}static{this.RATE_LIMIT_PER_DAY=1e3}static{this.RATE_LIMIT_PER_HOUR=100}constructor(){this.rateLimitTracker={daily:{used:0,remaining:1e3,resetTime:new Date},hourly:{used:0,remaining:100,resetTime:new Date}},this.accessToken=null,this.refreshToken=null,this.tokenExpiresAt=null,this.accessToken=process.env.TIKTOK_ACCESS_TOKEN||null,this.refreshToken=process.env.TIKTOK_REFRESH_TOKEN||null,process.env.TIKTOK_TOKEN_EXPIRES_AT&&(this.tokenExpiresAt=new Date(process.env.TIKTOK_TOKEN_EXPIRES_AT)),this.scraper=new h.x({headless:!0,rateLimitMs:12e4}),this.useWebScraping="true"!==process.env.TIKTOK_USE_API}async searchVideos(a){let b=Date.now();try{let c=a.keywords.join(" "),d=Math.min(a.limit||20,100),h=[];if(this.useWebScraping){await i.RE.logInfo("TikTokService","Using web scraping for video search",{keywords:a.keywords,limit:d});let b=await this.scraper.scrapeContent(c,d);if(!b.success)throw Error(`Web scraping failed: ${b.error}`);for(let c of b.data||[]){let b=await this.convertScrapedToProcessed(c);a.minViews&&b.viewCount<a.minViews||await this.validateTikTokContent(b)&&h.push(b)}await i.RE.logInfo("TikTokService","Web scraping search completed",{keywords:a.keywords,scraped:b.data?.length||0,processed:h.length,responseTime:b.responseTime})}else{if(!this.accessToken)throw Error("TikTok access token not available. Please authenticate first.");await this.checkRateLimit(),await this.checkTokenExpiration();let b=a.sortBy||"relevance",g=new URLSearchParams({query:c,max_count:d.toString(),sort_by:b,start_date:a.publishedAfter?a.publishedAfter.toISOString().split("T")[0]:new Date(Date.now()-6048e5).toISOString().split("T")[0]}),i=await fetch(`${l.API_BASE_URL}/v2/research/video/query/?${g}`,{method:"POST",headers:{Authorization:`Bearer ${this.accessToken}`,"Content-Type":"application/json"},body:JSON.stringify({query:{and:a.keywords.map(a=>({operation:"IN",field_name:"hashtag_name",field_values:[a]}))},max_count:d})});if(!i.ok){let a=await i.json().catch(()=>({}));throw Error(`TikTok API error: ${i.status} - ${a.error?.message||i.statusText}`)}let j=await i.json();if(this.updateRateLimit(),j.data&&j.data.videos)for(let b of j.data.videos)try{let c=await this.processTikTokVideo(b);if(a.minViews&&c.viewCount<a.minViews)continue;h.push(c)}catch(a){await (0,e.rP)(f.$b.WARNING,"TIKTOK_VIDEO_PROCESS_ERROR",`Failed to process TikTok video ${b.id}: ${a.message}`,{videoId:b.id,error:a.message})}}await (0,e.rP)(f.$b.INFO,"TIKTOK_SEARCH_SUCCESS",`Found ${h.length} TikTok videos for keywords: ${a.keywords.join(", ")}`,{keywords:a.keywords,videosFound:h.length,limit:d,method:this.useWebScraping?"scraping":"api"});let k=Date.now()-b;return await g.W.recordApiRequest(!0,k),await j.z.recordAPIMetric("tiktok","search_videos",k,200),h}catch(h){let c=Date.now()-b,d=h.message.includes("rate limit")?"rate_limit":h.message.includes("token")?"auth_error":h.message.includes("scraping")?"scraping_error":"api_error";throw await g.W.recordApiRequest(!1,c,d),await j.z.recordAPIMetric("tiktok","search_videos",c,500),h.message.includes("rate limit")&&await g.W.recordRateLimitHit(this.rateLimitTracker.hourly.resetTime),await (0,e.rP)(f.$b.ERROR,"TIKTOK_SEARCH_ERROR",`TikTok video search failed: ${h.message}`,{keywords:a.keywords,error:h.message,method:this.useWebScraping?"scraping":"api"}),Error(`TikTok video search failed: ${h.message}`)}}async getVideoDetails(a){try{if(!this.accessToken)throw Error("TikTok access token not available");await this.checkRateLimit(),await this.checkTokenExpiration();let b=await fetch(`${l.API_BASE_URL}/v2/video/info/?video_id=${a}`,{method:"GET",headers:{Authorization:`Bearer ${this.accessToken}`,"Content-Type":"application/json"}});if(!b.ok){let a=await b.json().catch(()=>({}));throw Error(`TikTok API error: ${b.status} - ${a.error?.message||b.statusText}`)}let c=await b.json();return this.updateRateLimit(),this.processTikTokVideo(c.data)}catch(b){throw await (0,e.rP)(f.$b.ERROR,"TIKTOK_VIDEO_DETAILS_ERROR",`Failed to get TikTok video details: ${b.message}`,{videoId:a,error:b.message}),b}}async convertScrapedToProcessed(a){try{let b=a.metadata?.hashtags||[];return{id:a.id,title:a.content_text?.substring(0,100)||"TikTok hotdog video",description:a.content_text||"",videoUrl:a.content_video_url||a.original_url,thumbnailUrl:a.metadata?.thumbnail_url||"",webUrl:a.original_url,username:a.original_author,userDisplayName:a.metadata?.display_name||a.original_author,userId:a.original_author,createdAt:a.metadata?.created_at||a.scraped_at,duration:0,viewCount:a.metadata?.views||0,likeCount:a.metadata?.likes||0,shareCount:a.metadata?.shares||0,commentCount:a.metadata?.comments||0,hashtags:b,effects:[],sounds:a.metadata?.music?{id:"scraped",title:a.metadata.music.title||"Unknown",author:a.metadata.music.author||"Unknown"}:void 0,isCommercial:!1,region:void 0}}catch(b){throw await i.RE.logError("TikTokService","Failed to convert scraped content",{scrapedId:a.id,error:b.message},b),b}}async processTikTokVideo(a){try{let b=this.extractHashtags(a.hashtag_names||[]),c=a.effect_ids||[];return{id:a.id,title:a.title||a.video_description||"",description:a.video_description||"",videoUrl:a.video_url||`https://www.tiktok.com/@${a.username}/video/${a.id}`,thumbnailUrl:a.cover_image_url||"",webUrl:`https://www.tiktok.com/@${a.username}/video/${a.id}`,username:a.username||"unknown",userDisplayName:a.user_display_name||a.username||"unknown",userId:a.user_id||"unknown",createdAt:new Date(1e3*a.create_time),duration:a.duration||0,viewCount:a.view_count||0,likeCount:a.like_count||0,shareCount:a.share_count||0,commentCount:a.comment_count||0,hashtags:b,effects:c,sounds:a.music?{id:a.music.id,title:a.music.title,author:a.music.author}:void 0,isCommercial:a.is_stem_verified||!1,region:a.region_code}}catch(b){throw await (0,e.rP)(f.$b.ERROR,"TIKTOK_VIDEO_PROCESS_ERROR",`Failed to process TikTok video: ${b.message}`,{videoId:a.id,error:b.message}),b}}async handleTikTokAuth(a,b){try{let c=process.env.TIKTOK_CLIENT_KEY,d=process.env.TIKTOK_CLIENT_SECRET;if(!c||!d)throw Error("TikTok client credentials not configured");let g=await fetch(l.TOKEN_URL,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({client_key:c,client_secret:d,code:a,grant_type:"authorization_code",redirect_uri:b||`${process.env.NEXT_PUBLIC_BASE_URL}/admin/tiktok/callback`})});if(!g.ok){let a=await g.json().catch(()=>({}));throw Error(`Token exchange failed: ${a.error_description||g.statusText}`)}let h=await g.json(),i={accessToken:h.access_token,refreshToken:h.refresh_token,expiresAt:new Date(Date.now()+1e3*h.expires_in),scope:h.scope?.split(",")||["user.info.basic","video.list"],openId:h.open_id};return this.accessToken=i.accessToken,this.refreshToken=i.refreshToken,this.tokenExpiresAt=i.expiresAt,await (0,e.rP)(f.$b.INFO,"TIKTOK_AUTH_SUCCESS","TikTok authentication completed successfully",{openId:i.openId,expiresAt:i.expiresAt}),i}catch(a){throw await (0,e.rP)(f.$b.ERROR,"TIKTOK_AUTH_ERROR",`TikTok authentication failed: ${a.message}`,{error:a.message}),a}}async refreshAccessToken(){try{if(!this.refreshToken)throw Error("No refresh token available");let a=process.env.TIKTOK_CLIENT_KEY,b=process.env.TIKTOK_CLIENT_SECRET;if(!a||!b)throw Error("TikTok client credentials not configured");let c=await fetch(l.TOKEN_URL,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({client_key:a,client_secret:b,grant_type:"refresh_token",refresh_token:this.refreshToken})});if(!c.ok){let a=await c.json().catch(()=>({}));throw Error(`Token refresh failed: ${a.error_description||c.statusText}`)}let d=await c.json();this.accessToken=d.access_token,this.refreshToken=d.refresh_token,this.tokenExpiresAt=new Date(Date.now()+1e3*d.expires_in),await (0,e.rP)(f.$b.INFO,"TIKTOK_TOKEN_REFRESHED","TikTok access token refreshed successfully",{expiresAt:this.tokenExpiresAt}),await g.W.recordTokenRefresh(!0,this.tokenExpiresAt)}catch(a){throw await g.W.recordTokenRefresh(!1),await (0,e.rP)(f.$b.ERROR,"TIKTOK_TOKEN_REFRESH_ERROR",`Failed to refresh TikTok access token: ${a.message}`,{error:a.message}),a}}async getApiStatus(){try{let a=!1;if(this.useWebScraping){let b=await this.scraper.testAccess();return{isAuthenticated:a=b.accessible,rateLimits:{used:0,remaining:999,resetTime:new Date(Date.now()+36e5)},lastRequest:new Date,lastError:b.error,quota:{daily:{used:0,limit:999},hourly:{used:0,limit:999}}}}if(this.accessToken&&this.tokenExpiresAt)try{a=(await fetch(`${l.API_BASE_URL}/v2/user/info/`,{method:"GET",headers:{Authorization:`Bearer ${this.accessToken}`,"Content-Type":"application/json"}})).ok,this.updateRateLimit()}catch(b){a=!1}return{isAuthenticated:a,rateLimits:this.rateLimitTracker.hourly,tokenExpiresAt:this.tokenExpiresAt||void 0,lastRequest:new Date,quota:{daily:this.rateLimitTracker.daily,hourly:this.rateLimitTracker.hourly}}}catch(a){return{isAuthenticated:!1,rateLimits:{used:0,remaining:0,resetTime:new Date},lastError:a.message,lastRequest:new Date,quota:{daily:{used:0,limit:l.RATE_LIMIT_PER_DAY},hourly:{used:0,limit:l.RATE_LIMIT_PER_HOUR}}}}}getHotdogKeywords(){return["hotdog","hot dog","hotdogs","frankfurter","wiener","bratwurst","sausage","corndog","chilidog","hotdogchallenge","foodtok","grilling","bbq","ballparkfood","streetfood","fastfood","hotdogrecipe","grilledhotdog","americanfood"]}getFoodHashtags(){return["foodtok","hotdogchallenge","grilling","bbqtok","streetfood","fastfood","americanfood","foodie","cookingshow","recipetok","foodprep","grilltok"]}async validateTikTokContent(a){try{let b=`${a.title} ${a.description}`.toLowerCase(),c=["hotdog","hot dog","hotdogs","hot dogs","frankfurter","wiener","bratwurst","sausage","chili dog","corn dog","ballpark frank"].some(a=>b.includes(a)),d=a.hashtags.some(a=>this.getHotdogKeywords().includes(a.toLowerCase()));if(!c&&!d||["buy now","click link","dm me","link in bio","promo code","discount","sale","affiliate","subscribe","follow for more"].some(a=>b.includes(a)))return!1;let e=a.viewCount>1e3||a.likeCount>50;return a.videoUrl&&a.videoUrl.length>0&&e}catch(b){return await (0,e.rP)(f.$b.ERROR,"TIKTOK_VALIDATION_ERROR",`TikTok content validation failed: ${b.message}`,{videoId:a.id,error:b.message}),!1}}extractHashtags(a){return a.map(a=>a.replace("#","").toLowerCase())}async checkRateLimit(){let a=new Date;if(a>=this.rateLimitTracker.hourly.resetTime&&(this.rateLimitTracker.hourly.used=0,this.rateLimitTracker.hourly.remaining=l.RATE_LIMIT_PER_HOUR,this.rateLimitTracker.hourly.resetTime=new Date(a.getTime()+36e5)),a>=this.rateLimitTracker.daily.resetTime&&(this.rateLimitTracker.daily.used=0,this.rateLimitTracker.daily.remaining=l.RATE_LIMIT_PER_DAY,this.rateLimitTracker.daily.resetTime=new Date(a.getTime()+864e5)),this.rateLimitTracker.hourly.remaining<=0){let b=this.rateLimitTracker.hourly.resetTime.getTime()-a.getTime();throw Error(`TikTok API hourly rate limit exceeded. Reset in ${Math.ceil(b/1e3)} seconds`)}if(this.rateLimitTracker.daily.remaining<=0){let b=this.rateLimitTracker.daily.resetTime.getTime()-a.getTime();throw Error(`TikTok API daily rate limit exceeded. Reset in ${Math.ceil(b/36e5)} hours`)}}async checkTokenExpiration(){if(!this.tokenExpiresAt)return;let a=new Date;this.tokenExpiresAt.getTime()-a.getTime()<864e5&&await this.refreshAccessToken()}updateRateLimit(){this.rateLimitTracker.hourly.used++,this.rateLimitTracker.hourly.remaining=Math.max(0,l.RATE_LIMIT_PER_HOUR-this.rateLimitTracker.hourly.used),this.rateLimitTracker.daily.used++,this.rateLimitTracker.daily.remaining=Math.max(0,l.RATE_LIMIT_PER_DAY-this.rateLimitTracker.daily.used)}async cleanup(){this.useWebScraping&&this.scraper&&await this.scraper.cleanup()}getServiceStats(){return this.useWebScraping?{mode:"web_scraping",scraper_stats:this.scraper.getTikTokStats(),rate_limits:this.rateLimitTracker}:{mode:"api",rate_limits:this.rateLimitTracker,token_expires_at:this.tokenExpiresAt}}}let m=new l;d()}catch(a){d(a)}})},23292:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.d(b,{W:()=>j});var e=c(7462),f=c(35144),g=c(55229),h=a([e,g]);[e,g]=h.then?(await h)():h;class i{static{this.ERROR_RATE_THRESHOLD=20}static{this.LATENCY_THRESHOLD=1e4}static{this.HOURLY_QUOTA_WARNING_THRESHOLD=80}static{this.DAILY_QUOTA_WARNING_THRESHOLD=90}static{this.TOKEN_EXPIRY_WARNING_HOURS=24}async getHealthMetrics(){try{let a=await (0,g.P)("system_logs").select(["log_level","message","created_at"]).where("component","like","TIKTOK_%").where("created_at",">=",new Date(Date.now()-36e5)).orderBy("created_at","desc").limit(100),b=await this.determineAuthenticationStatus(),c=this.determineRateLimitStatus(a),d=await this.determineScanStatus(),e=this.calculateErrorRate(a),f=await this.calculateAverageResponseTime(),h=await this.getLastSuccessfulScan(),i=await this.calculateUptime(),j=this.countRecentAlerts(),k=await this.getTokenExpiryDate(),l=await this.getQuotaUsage();return{authenticationStatus:b,rateLimitStatus:c,scanStatus:d,errorRate:e,averageResponseTime:f,lastSuccessfulScan:h,uptime:i,alertsTriggered:j,tokenExpiry:k,quotaUsage:l}}catch(a){return await (0,e.rP)(f.$b.ERROR,"TIKTOK_HEALTH_CHECK_ERROR",`Failed to get TikTok health metrics: ${a.message}`,{error:a.message}),{authenticationStatus:"critical",rateLimitStatus:"warning",scanStatus:"error",errorRate:100,averageResponseTime:0,uptime:0,alertsTriggered:1,quotaUsage:{hourly:{used:0,limit:100,percentage:0},daily:{used:0,limit:1e3,percentage:0}}}}}async recordApiRequest(a,b,c){try{this.metrics.requestsPerHour++,a?this.metrics.averageLatency=(this.metrics.averageLatency+b)/2:c&&(this.metrics.errorsByType[c]=(this.metrics.errorsByType[c]||0)+1),this.metrics.peakLatency=Math.max(this.metrics.peakLatency,b),await this.checkPerformanceThresholds(a,b,c),b>i.LATENCY_THRESHOLD&&await (0,e.rP)(f.$b.WARNING,"TIKTOK_HIGH_LATENCY",`TikTok API request took ${b}ms`,{latency:b,success:a,errorType:c})}catch(a){console.error("Failed to record TikTok API request:",a)}}async recordRateLimitHit(a,b="hourly"){try{this.metrics.rateLimitHits++,await this.triggerAlert({type:"rate_limit",severity:"daily"===b?"critical":"high",message:`TikTok API ${b} rate limit exceeded. Reset at ${a.toISOString()}`,metadata:{resetTime:a.toISOString(),quotaType:b}})}catch(a){console.error("Failed to record TikTok rate limit hit:",a)}}async recordQuotaUsage(a,b,c=100,d=1e3){try{this.metrics.quotaUsage.hourlyUsed=a,this.metrics.quotaUsage.dailyUsed=b;let e=a/c*100,f=b/d*100;e>=i.HOURLY_QUOTA_WARNING_THRESHOLD&&await this.triggerAlert({type:"quota_exceeded",severity:e>=95?"critical":"high",message:`TikTok hourly quota ${e.toFixed(1)}% used (${a}/${c})`,metadata:{quotaType:"hourly",used:a,limit:c,percentage:e}}),f>=i.DAILY_QUOTA_WARNING_THRESHOLD&&await this.triggerAlert({type:"quota_exceeded",severity:f>=98?"critical":"high",message:`TikTok daily quota ${f.toFixed(1)}% used (${b}/${d})`,metadata:{quotaType:"daily",used:b,limit:d,percentage:f}})}catch(a){console.error("Failed to record TikTok quota usage:",a)}}async recordTokenRefresh(a,b){try{this.metrics.authenticationRefreshes++,a&&b?await (0,e.rP)(f.$b.INFO,"TIKTOK_TOKEN_REFRESH_SUCCESS","TikTok access token refreshed successfully",{newExpiryDate:b}):await this.triggerAlert({type:"auth_error",severity:"critical",message:"TikTok token refresh failed",metadata:{success:a}})}catch(a){console.error("Failed to record TikTok token refresh:",a)}}async recordScanCompletion(a,b,c){try{b&&(this.metrics.videosProcessedPerHour+=a),(!b||c.length>0)&&await this.triggerAlert({type:"scan_failure",severity:c.length>5?"critical":c.length>2?"high":"medium",message:`TikTok scan completed with ${c.length} errors`,metadata:{videosProcessed:a,errors:c.slice(0,5)}})}catch(a){console.error("Failed to record TikTok scan completion:",a)}}async checkTokenExpiry(){try{let a=await this.getTokenExpiryDate();if(a){let b=(a.getTime()-Date.now())/36e5;b<=i.TOKEN_EXPIRY_WARNING_HOURS&&await this.triggerAlert({type:"token_expiry",severity:b<=2?"critical":b<=12?"high":"medium",message:`TikTok token expires in ${Math.ceil(b)} hours`,metadata:{expiryDate:a.toISOString(),hoursUntilExpiry:Math.ceil(b)}})}}catch(a){console.error("Failed to check TikTok token expiry:",a)}}getPerformanceMetrics(){return{...this.metrics}}getActiveAlerts(){return this.alerts.filter(a=>!a.resolved)}async resolveAlert(a){let b=this.alerts.find(b=>b.id===a);b&&(b.resolved=!0,b.resolvedAt=new Date,await (0,e.rP)(f.$b.INFO,"TIKTOK_ALERT_RESOLVED",`TikTok alert resolved: ${b.message}`,{alertId:a,alertType:b.type}))}resetMetrics(){this.metrics={requestsPerHour:0,successRate:0,averageLatency:0,peakLatency:0,errorsByType:{},rateLimitHits:0,videosProcessedPerHour:0,authenticationRefreshes:0,quotaUsage:{hourlyUsed:0,dailyUsed:0}};let a=new Date(Date.now()-864e5);this.alerts=this.alerts.filter(b=>!b.resolved||b.resolvedAt&&b.resolvedAt>a)}async determineAuthenticationStatus(){try{let a=await (0,g.P)("tiktok_auth").select(["expires_at","is_active"]).where("is_active",!0).orderBy("created_at","desc").first();if(!a)return"critical";let b=(new Date(a.expires_at).getTime()-Date.now())/36e5;if(b<=2)return"critical";if(b<=24)return"warning";return"healthy"}catch(a){return"critical"}}determineRateLimitStatus(a){let b=a.filter(a=>a.message.toLowerCase().includes("rate limit")||a.message.toLowerCase().includes("quota"));return b.length>5?"critical":b.length>2?"warning":"healthy"}async determineScanStatus(){try{let a=await (0,g.P)("tiktok_scan_config").select(["is_enabled","last_scan_time"]).first();if(!a||!a.is_enabled)return"paused";if(a.last_scan_time){let b=new Date(a.last_scan_time),c=new Date(Date.now()-144e5);if(b<c)return"error"}return"active"}catch(a){return"error"}}calculateErrorRate(a){let b=a.length;if(0===b)return 0;let c=a.filter(a=>"error"===a.log_level);return Math.round(c.length/b*100)}async calculateAverageResponseTime(){return this.metrics.averageLatency}async getLastSuccessfulScan(){try{let a=await (0,g.P)("tiktok_scan_results").select(["end_time"]).where("videos_approved",">",0).orderBy("end_time","desc").first();return a?new Date(a.end_time):void 0}catch(a){return}}async calculateUptime(){try{let a=new Date(Date.now()-864e5),b=await (0,g.P)("system_logs").count("*").where("log_level","error").where("component","like","TIKTOK_%").where("created_at",">=",a).first(),c=parseInt(b?.count||"0"),d=Math.max(0,(96-c)/96*100);return Math.round(d)}catch(a){return 0}}async getTokenExpiryDate(){try{let a=await (0,g.P)("tiktok_auth").select(["expires_at"]).where("is_active",!0).orderBy("created_at","desc").first();return a?new Date(a.expires_at):void 0}catch(a){return}}async getQuotaUsage(){let a=this.metrics.quotaUsage.hourlyUsed,b=this.metrics.quotaUsage.dailyUsed;return{hourly:{used:a,limit:100,percentage:Math.round(a/100*100)},daily:{used:b,limit:1e3,percentage:Math.round(b/1e3*100)}}}countRecentAlerts(){let a=new Date(Date.now()-36e5);return this.alerts.filter(b=>b.timestamp>a).length}async checkPerformanceThresholds(a,b,c){let d=this.calculateCurrentErrorRate();d>i.ERROR_RATE_THRESHOLD&&await this.triggerAlert({type:"high_error_rate",severity:"critical",message:`TikTok API error rate is ${d}%`,metadata:{errorRate:d}}),b>i.LATENCY_THRESHOLD&&await this.triggerAlert({type:"api_error",severity:"high",message:`TikTok API latency is high: ${b}ms`,metadata:{latency:b}})}calculateCurrentErrorRate(){let a=this.metrics.requestsPerHour,b=Object.values(this.metrics.errorsByType).reduce((a,b)=>a+b,0);return a>0?Math.round(b/a*100):0}async triggerAlert(a){if(this.alerts.find(b=>b.type===a.type&&!b.resolved&&Date.now()-b.timestamp.getTime()<36e5))return;let b={id:`tiktok_alert_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,timestamp:new Date,resolved:!1,...a};this.alerts.push(b),await (0,e.rP)("critical"===a.severity?f.$b.FATAL:"high"===a.severity?f.$b.ERROR:"medium"===a.severity?f.$b.WARN:f.$b.INFO,"TIKTOK_ALERT_TRIGGERED",b.message,{alertId:b.id,alertType:b.type,severity:b.severity,metadata:b.metadata})}constructor(){this.alerts=[],this.metrics={requestsPerHour:0,successRate:0,averageLatency:0,peakLatency:0,errorsByType:{},rateLimitHits:0,videosProcessedPerHour:0,authenticationRefreshes:0,quotaUsage:{hourlyUsed:0,dailyUsed:0}}}}let j=new i;d()}catch(a){d(a)}})},75905:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.d(b,{x:()=>i});var e=c(93785),f=c(99986),g=c(73790),h=a([e,f,g]);[e,f,g]=h.then?(await h)():h;class i extends e.P{constructor(a){super({rateLimitMs:12e4,timeout:45e3,...a}),this.baseUrl="https://www.tiktok.com",this.searchTerms=["hotdog","hotdogs","hot dog recipe","hotdog challenge","food hotdog"]}async scrapeContent(a,b=15){let c=Date.now(),d=a||this.getRandomSearchTerm(),e=`tiktok_${d}_${b}`;try{let a=this.getCachedData(e,9e5);if(a)return await f.RE.logDebug("TikTokScraper","Returning cached data",{searchTerm:d,count:a.length}),{success:!0,data:a,timestamp:new Date,url:`${this.baseUrl}/search?q=${encodeURIComponent(d)}`,responseTime:Date.now()-c};await f.RE.logInfo("TikTokScraper","Starting TikTok scraping",{searchTerm:d,limit:b});let h=await this.createPage();await h.setExtraHTTPHeaders({Referer:"https://www.tiktok.com/",Origin:"https://www.tiktok.com"});let i=`${this.baseUrl}/search?q=${encodeURIComponent(d)}`,j=await this.navigateWithRetry(h,i);if(!j.success)return await h.close(),{success:!1,error:j.error,timestamp:new Date,url:i,responseTime:Date.now()-c};await this.handleInitialLoad(h);let k=(await this.extractVideos(h,b)).map(a=>this.convertToScrapedContent(a));return this.setCachedData(e,k),await h.close(),await g.z.recordCustomMetric("tiktok_scraping_success",Date.now()-c,"ms",{searchTerm:d,videosFound:k.length.toString(),requestedLimit:b.toString()}),await f.RE.logInfo("TikTokScraper","TikTok scraping completed",{searchTerm:d,videosFound:k.length,responseTime:Date.now()-c}),{success:!0,data:k,timestamp:new Date,url:i,responseTime:Date.now()-c}}catch(a){return await f.RE.logError("TikTokScraper","TikTok scraping failed",{searchTerm:d,error:a.message},a),await g.z.recordCustomMetric("tiktok_scraping_failed",Date.now()-c,"ms",{searchTerm:d,error:a.message}),{success:!1,error:a.message,timestamp:new Date,url:`${this.baseUrl}/search?q=${encodeURIComponent(d)}`,responseTime:Date.now()-c}}}async handleInitialLoad(a){try{await a.waitForTimeout(3e3);let b=a.locator('button:has-text("Accept"), button:has-text("Allow"), button:has-text("OK")');await b.first().isVisible({timeout:2e3})&&(await b.first().click(),await a.waitForTimeout(1e3));let c=a.locator('[data-e2e="close-button"], button[aria-label="Close"], .close-button');await c.first().isVisible({timeout:2e3})&&(await c.first().click(),await a.waitForTimeout(1e3)),await a.waitForSelector('[data-e2e="search_top-item"], .video-feed-item, [data-e2e="recommend-list-item"]',{timeout:15e3}).catch(()=>a.waitForSelector('div[data-e2e*="video"], a[href*="/video/"]',{timeout:1e4}))}catch(a){await f.RE.logWarning("TikTokScraper","Could not handle initial load elements",{error:a.message})}}async extractVideos(a,b){let c=[];try{await this.scrollToLoadContent(a,b);let d=await a.evaluate(a=>{let b=[],c=[];for(let a of['[data-e2e="search_top-item"]',".video-feed-item",'[data-e2e="recommend-list-item"]','div[data-e2e*="video"]','a[href*="/video/"]'])if((c=Array.from(document.querySelectorAll(a))).length>0)break;for(let d=0;d<Math.min(c.length,a);d++){let a=c[d];try{let c=a.querySelector('a[href*="/video/"]')||a.closest('a[href*="/video/"]')||a,d=c?.getAttribute("href");if(!d)continue;let e=d.match(/\/video\/(\d+)/),f=e?.[1];if(!f)continue;let g=a.querySelector("img"),h=g?.src||g?.getAttribute("data-src")||"",i=a.querySelector('div[data-e2e="search-card-desc"], .video-meta-caption, [title]'),j=i?.textContent?.trim()||i?.getAttribute("title")||g?.getAttribute("alt")||"TikTok hotdog video",k=a.querySelector('a[data-e2e="search-card-user-link"], .author-link, [href*="/@"]'),l=(k?.getAttribute("href")||"").match(/@([^/?]+)/),m=l?.[1]||"unknown",n=a.querySelector('[data-e2e="video-views"], .view-count'),o=a.querySelector('[data-e2e="like-count"], .like-count'),p=n?.textContent?.trim()||"0",q=o?.textContent?.trim()||"0",r=a=>{let b=a.match(/([\d.]+)([KMB]?)/);if(!b)return 0;let c=parseFloat(b[1]);switch(b[2]){case"K":return Math.floor(1e3*c);case"M":return Math.floor(1e6*c);case"B":return Math.floor(1e9*c);default:return Math.floor(c)}};b.push({id:f,video_url:`https://www.tiktok.com${d}`,thumbnail_url:h,description:j,author:{username:m,profile_url:`https://www.tiktok.com/@${m}`},post_url:`https://www.tiktok.com${d}`,view_count:r(p),like_count:r(q),hashtags:this.extractHashtagsFromText(j),created_at:new Date})}catch(a){console.warn("Error extracting video data:",a)}}return b},b);c.push(...d)}catch(a){await f.RE.logWarning("TikTokScraper","Error extracting videos",{error:a.message})}return c}async scrollToLoadContent(a,b){let c=0,d=0;for(;d<6&&!(await a.evaluate(()=>{for(let a of['[data-e2e="search_top-item"]',".video-feed-item",'a[href*="/video/"]']){let b=document.querySelectorAll(a);if(b.length>0)return b.length}return 0})>=b);){await a.evaluate(()=>{window.scrollBy(0,window.innerHeight)}),await a.waitForTimeout(3e3);let b=await a.evaluate(()=>document.body.scrollHeight);b===c?d++:d=0,c=b}}convertToScrapedContent(a){return{id:a.id,platform:"tiktok",type:"video",content_video_url:a.video_url,content_text:a.description,original_url:a.post_url,original_author:a.author.username,original_author_url:a.author.profile_url,scraped_at:new Date,metadata:{views:a.view_count,likes:a.like_count,comments:a.comment_count,shares:a.share_count,hashtags:a.hashtags,thumbnail_url:a.thumbnail_url,music:a.music,created_at:a.created_at,display_name:a.author.display_name}}}extractHashtagsFromText(a){return(a.match(/#[\w\u00c0-\u024f\u1e00-\u1eff]+/gi)||[]).map(a=>a.substring(1).toLowerCase())}getRandomSearchTerm(){return this.searchTerms[Math.floor(Math.random()*this.searchTerms.length)]}async testAccess(){try{let a=await this.createPage(),b=await this.navigateWithRetry(a,`${this.baseUrl}/search?q=hotdog`);return await a.close(),{accessible:b.success,error:b.error}}catch(a){return{accessible:!1,error:a.message}}}getAvailableSearchTerms(){return[...this.searchTerms]}getTikTokStats(){return{...this.getStats(),availableSearchTerms:this.searchTerms,rateLimitMs:this.config.rateLimitMs}}}d()}catch(a){d(a)}})},93785:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.d(b,{P:()=>k});var e=c(83237),f=c(99986),g=c(73790),h=c(31977),i=c.n(h),j=a([e,f,g]);[e,f,g]=j.then?(await j)():j;class k{constructor(a={}){this.lastRequestTime=0,this.requestCount=0,this.cache=new Map,this.config={headless:!0,stealth:!0,timeout:3e4,rateLimitMs:6e4,maxRetries:3,viewport:{width:1920,height:1080},...a},this.userAgents=new(i())({deviceCategory:"desktop"})}async initialize(){try{await f.RE.logInfo("WebScrapingBase","Initializing browser for web scraping"),this.browser=await e.chromium.launch({headless:this.config.headless,args:["--no-sandbox","--disable-setuid-sandbox","--disable-dev-shm-usage","--disable-accelerated-2d-canvas","--no-first-run","--no-zygote","--disable-gpu","--disable-web-security","--disable-features=VizDisplayCompositor"]}),this.context=await this.browser.newContext({userAgent:this.config.userAgent||this.userAgents.toString(),viewport:this.config.viewport,proxy:this.config.proxy,permissions:[],geolocation:{latitude:37.7749,longitude:-122.4194},locale:"en-US",timezoneId:"America/Los_Angeles",extraHTTPHeaders:{"Accept-Language":"en-US,en;q=0.9","Accept-Encoding":"gzip, deflate, br",Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8","Upgrade-Insecure-Requests":"1","Sec-Fetch-Dest":"document","Sec-Fetch-Mode":"navigate","Sec-Fetch-Site":"none","Cache-Control":"max-age=0"}}),await this.context.addInitScript(()=>{Object.defineProperty(navigator,"webdriver",{get:()=>!1}),Object.defineProperty(navigator,"plugins",{get:()=>[1,2,3,4,5]}),Object.defineProperty(navigator,"languages",{get:()=>["en-US","en"]}),delete window.cdc_adoQpoasnfa76pfcZLmcfl_Array,delete window.cdc_adoQpoasnfa76pfcZLmcfl_Promise,delete window.cdc_adoQpoasnfa76pfcZLmcfl_Symbol}),await f.RE.logInfo("WebScrapingBase","Browser initialized successfully")}catch(a){throw await f.RE.logError("WebScrapingBase","Failed to initialize browser",{error:a.message},a),a}}async createPage(){this.context||await this.initialize();let a=await this.context.newPage();return await a.setExtraHTTPHeaders({"Accept-Language":"en-US,en;q=0.9","Accept-Encoding":"gzip, deflate, br"}),await a.route("**/*",a=>{let b=a.request(),c=b.resourceType();if(["stylesheet","font","image"].includes(c)&&"image"===c&&!this.isContentImage(b.url())||b.url().includes("google-analytics")||b.url().includes("facebook.com/tr")||b.url().includes("doubleclick")||b.url().includes("ads"))return void a.abort();a.continue()}),a}async rateLimit(){let a=Date.now()-this.lastRequestTime;if(a<this.config.rateLimitMs){let b=this.config.rateLimitMs-a;await f.RE.logDebug("WebScrapingBase",`Rate limiting: waiting ${b}ms`),await this.delay(b)}this.lastRequestTime=Date.now(),this.requestCount++}async navigateWithRetry(a,b){let c=Date.now();for(let d=1;d<=this.config.maxRetries;d++)try{await this.rateLimit(),await f.RE.logDebug("WebScrapingBase",`Navigating to URL (attempt ${d})`,{url:b,attempt:d});let e=await a.goto(b,{waitUntil:"networkidle",timeout:this.config.timeout});if(!e||e.status()>=400)throw Error(`HTTP ${e?.status()} - ${e?.statusText()}`);let h=Date.now()-c;return await g.z.recordCustomMetric("scraping_navigation_success",h,"ms",{url:this.sanitizeUrl(b),attempt:d.toString()}),{success:!0,timestamp:new Date,url:b,responseTime:h}}catch(e){if(await f.RE.logWarning("WebScrapingBase",`Navigation attempt ${d} failed`,{url:b,attempt:d,error:e.message}),d===this.config.maxRetries){let a=Date.now()-c;return await g.z.recordCustomMetric("scraping_navigation_failed",a,"ms",{url:this.sanitizeUrl(b),error:e.message}),{success:!1,error:e.message,timestamp:new Date,url:b,responseTime:a}}let a=Math.min(1e3*Math.pow(2,d-1),1e4);await this.delay(a)}return{success:!1,error:"Max retries exceeded",timestamp:new Date,url:b,responseTime:Date.now()-c}}getCachedData(a,b=3e5){let c=this.cache.get(a);return c&&Date.now()-c.timestamp<b?c.data:null}setCachedData(a,b){this.cache.set(a,{data:b,timestamp:Date.now()}),this.cache.size>1e3&&Array.from(this.cache.entries()).sort(([,a],[,b])=>a.timestamp-b.timestamp).slice(0,100).forEach(([a])=>this.cache.delete(a))}async cleanup(){try{this.context&&await this.context.close(),this.browser&&await this.browser.close(),await f.RE.logInfo("WebScrapingBase","Browser cleanup completed",{requestCount:this.requestCount})}catch(a){await f.RE.logError("WebScrapingBase","Error during cleanup",{error:a.message},a)}}rotateUserAgent(){return this.userAgents.toString()}delay(a){return new Promise(b=>setTimeout(b,a))}sanitizeUrl(a){try{let b=new URL(a);return b.searchParams.delete("access_token"),b.searchParams.delete("session_id"),b.searchParams.delete("auth"),b.toString()}catch{return a}}isContentImage(a){return!a.includes("ads")&&!a.includes("analytics")&&!a.includes("tracking")&&!a.includes("1x1")&&(a.includes("cdninstagram")||a.includes("tiktokcdn")||a.includes("scontent"))}getStats(){return{requestCount:this.requestCount,cacheSize:this.cache.size,lastRequestTime:this.lastRequestTime}}}d()}catch(a){d(a)}})}};