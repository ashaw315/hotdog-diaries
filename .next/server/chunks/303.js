"use strict";exports.id=303,exports.ids=[303],exports.modules={303:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.d(b,{t:()=>o});var e=c(90467),f=c(76865),g=c(29159),h=c(40704),i=c(1366),j=c(55229),k=c(7462),l=c(35144),m=a([e,f,g,h,i,j,k]);[e,f,g,h,i,j,k]=m.then?(await m)():m;class n{constructor(){this.isScanning=!1,this.instagramService=new e.g,this.filteringService=new f.G,this.contentProcessor=new g.Q,this.duplicateDetection=new h.Y}async startAutomatedScanning(){try{let a=await this.getScanConfig();if(!a.isEnabled)return void await (0,k.rP)(l.$b.INFO,"INSTAGRAM_SCAN_DISABLED","Instagram scanning is disabled in configuration");if(!(await this.instagramService.getApiStatus()).isAuthenticated)return void await (0,k.rP)(l.$b.WARNING,"INSTAGRAM_NOT_AUTHENTICATED","Instagram scanning cannot start: not authenticated");this.scanTimer&&clearInterval(this.scanTimer);let b=60*a.scanInterval*1e3;this.scanTimer=setInterval(async()=>{this.isScanning||await this.performScan()},b),await this.performScan(),await (0,k.rP)(l.$b.INFO,"INSTAGRAM_SCAN_STARTED",`Instagram scanning started with ${a.scanInterval} minute intervals`,{config:a})}catch(a){throw await (0,k.rP)(l.$b.ERROR,"INSTAGRAM_SCAN_START_ERROR",`Failed to start Instagram scanning: ${a.message}`,{error:a.message}),a}}async stopAutomatedScanning(){this.scanTimer&&(clearInterval(this.scanTimer),this.scanTimer=void 0),await (0,k.rP)(l.$b.INFO,"INSTAGRAM_SCAN_STOPPED","Instagram scanning stopped")}async performScan(){if(this.isScanning)throw Error("Instagram scan already in progress");this.isScanning=!0;let a=`instagram_scan_${Date.now()}`,b=new Date,c={scanId:a,startTime:b,endTime:new Date,postsFound:0,postsProcessed:0,postsApproved:0,postsRejected:0,postsFlagged:0,duplicatesFound:0,errors:[],rateLimitHit:!1,hashtagsScanned:[]};try{let b=await this.getScanConfig();if(!b.isEnabled)throw Error("Instagram scanning is disabled");if(!(await this.instagramService.getApiStatus()).isAuthenticated)throw Error("Instagram not authenticated");let d=[];for(let e of(c.hashtagsScanned=b.targetHashtags,b.targetHashtags))try{let c={hashtag:e,limit:Math.floor(b.maxPostsPerScan/b.targetHashtags.length),minLikes:b.minLikes,includeStories:b.includeStories},f=await this.instagramService.searchHashtags(c);d=d.concat(f),await (0,k.rP)(l.$b.INFO,"INSTAGRAM_HASHTAG_SEARCH_SUCCESS",`Found ${f.length} Instagram posts for hashtag #${e}`,{scanId:a,hashtag:e,postsFound:f.length})}catch(b){c.errors.push(`Hashtag "#${e}" search failed: ${b.message}`),b.message.includes("rate limit")&&(c.rateLimitHit=!0),await (0,k.rP)(l.$b.ERROR,"INSTAGRAM_HASHTAG_SEARCH_ERROR",`Hashtag search failed: #${e} - ${b.message}`,{scanId:a,hashtag:e,error:b.message})}c.postsFound=d.length;let e=this.removeDuplicatePosts(d);if(c.duplicatesFound=d.length-e.length,e.length>0){let a=e.reduce((a,b)=>b.likesCount+b.commentsCount>a.likesCount+a.commentsCount?b:a);c.highestEngagedPost={id:a.id,caption:a.caption.substring(0,100)+"...",likesCount:a.likesCount,username:a.username}}for(let b of e)try{let d=await this.processInstagramPost(b,a);switch(c.postsProcessed++,d.status){case"approved":c.postsApproved++;break;case"rejected":c.postsRejected++;break;case"flagged":c.postsFlagged++}}catch(d){c.errors.push(`Post ${b.id} processing failed: ${d.message}`),await (0,k.rP)(l.$b.ERROR,"INSTAGRAM_POST_PROCESS_ERROR",`Failed to process Instagram post ${b.id}: ${d.message}`,{scanId:a,postId:b.id,error:d.message})}return await this.updateLastScanTime(),c.endTime=new Date,c.nextScanTime=new Date(Date.now()+60*b.scanInterval*1e3),await this.recordScanResult(c),await (0,k.rP)(l.$b.INFO,"INSTAGRAM_SCAN_COMPLETED",`Instagram scan completed: ${c.postsProcessed} processed, ${c.postsApproved} approved`,c),await i.O.recordScanCompletion(c.postsProcessed,!0,c.errors),c}catch(b){throw c.errors.push(b.message),c.endTime=new Date,await (0,k.rP)(l.$b.ERROR,"INSTAGRAM_SCAN_ERROR",`Instagram scan failed: ${b.message}`,{scanId:a,error:b.message}),await i.O.recordScanCompletion(c.postsProcessed,!1,c.errors),b}finally{this.isScanning=!1}}async processInstagramPost(a,b){try{if(!await this.instagramService.validateInstagramContent(a))return{status:"rejected"};let c=`${a.caption}`.trim(),d=await this.duplicateDetection.generateContentHash(c);if(await this.duplicateDetection.checkForDuplicates({content_text:c,content_image_url:a.mediaUrl,content_video_url:"VIDEO"===a.mediaType?a.mediaUrl:void 0,content_hash:d}))return{status:"rejected"};let e=this.determineContentType(a),f={content_text:c,content_image_url:"IMAGE"===a.mediaType?a.mediaUrl:a.thumbnailUrl,content_video_url:"VIDEO"===a.mediaType?a.mediaUrl:null,content_type:e,source_platform:"instagram",original_url:a.permalink,original_author:`@${a.username}`,scraped_at:new Date,content_hash:d,instagram_data:JSON.stringify({post_id:a.id,username:a.username,user_id:a.userId,media_type:a.mediaType,likes_count:a.likesCount,comments_count:a.commentsCount,hashtags:a.hashtags,mentions:a.mentions,location:a.location,is_story:a.isStory,carousel_media:a.carouselMedia,timestamp:a.timestamp,scan_id:b})},g=await (0,j.Yr)("content_queue").values(f).returning(["id"]).first();if(!g)throw Error("Failed to insert content into queue");return{status:(await this.contentProcessor.processContent(g.id)).action}}catch(c){throw await (0,k.rP)(l.$b.ERROR,"INSTAGRAM_POST_PROCESS_ERROR",`Failed to process Instagram post ${a.id}: ${c.message}`,{postId:a.id,scanId:b,error:c.message,post:{caption:a.caption.substring(0,100),username:a.username,likesCount:a.likesCount}}),c}}determineContentType(a){let b=a.caption.trim().length>0;switch(a.mediaType){case"VIDEO":return b?"mixed":"video";case"IMAGE":return b?"mixed":"image";case"CAROUSEL_ALBUM":return"mixed";default:return b?"text":"image"}}removeDuplicatePosts(a){let b=new Set;return a.filter(a=>!b.has(a.id)&&(b.add(a.id),!0))}async getScanConfig(){try{let a=await (0,j.P)("instagram_scan_config").select("*").first();if(!a)return{isEnabled:!1,scanInterval:60,maxPostsPerScan:20,targetHashtags:this.instagramService.getHotdogHashtags().slice(0,8),minLikes:5,includeStories:!1};return{isEnabled:a.is_enabled,scanInterval:a.scan_interval,maxPostsPerScan:a.max_posts_per_scan,targetHashtags:a.target_hashtags||this.instagramService.getHotdogHashtags().slice(0,8),minLikes:a.min_likes,includeStories:a.include_stories,lastScanId:a.last_scan_id,lastScanTime:a.last_scan_time?new Date(a.last_scan_time):void 0}}catch(a){return{isEnabled:!1,scanInterval:60,maxPostsPerScan:20,targetHashtags:this.instagramService.getHotdogHashtags().slice(0,8),minLikes:5,includeStories:!1}}}async updateScanConfig(a){try{let b={...await this.getScanConfig(),...a};await (0,j.P)("instagram_scan_config").upsert({is_enabled:b.isEnabled,scan_interval:b.scanInterval,max_posts_per_scan:b.maxPostsPerScan,target_hashtags:b.targetHashtags,min_likes:b.minLikes,include_stories:b.includeStories,last_scan_id:b.lastScanId,last_scan_time:b.lastScanTime,updated_at:new Date}),await (0,k.rP)(l.$b.INFO,"INSTAGRAM_CONFIG_UPDATED","Instagram scan configuration updated",{config:b})}catch(b){throw await (0,k.rP)(l.$b.ERROR,"INSTAGRAM_CONFIG_UPDATE_ERROR",`Failed to update Instagram configuration: ${b.message}`,{config:a,error:b.message}),b}}async updateLastScanTime(){await this.updateScanConfig({lastScanTime:new Date})}async recordScanResult(a){try{await (0,j.Yr)("instagram_scan_results").values({scan_id:a.scanId,start_time:a.startTime,end_time:a.endTime,posts_found:a.postsFound,posts_processed:a.postsProcessed,posts_approved:a.postsApproved,posts_rejected:a.postsRejected,posts_flagged:a.postsFlagged,duplicates_found:a.duplicatesFound,hashtags_scanned:a.hashtagsScanned,highest_likes:a.highestEngagedPost?.likesCount||0,errors:a.errors,rate_limit_hit:a.rateLimitHit,created_at:new Date})}catch(b){await (0,k.rP)(l.$b.WARNING,"INSTAGRAM_SCAN_RESULT_RECORD_ERROR",`Failed to record Instagram scan result: ${b.message}`,{scanId:a.scanId,error:b.message})}}async getScanStats(){try{let a=await (0,j.P)("instagram_scan_results").select(["COUNT(*) as total_scans","SUM(posts_found) as total_posts_found","SUM(posts_processed) as total_posts_processed","SUM(posts_approved) as total_posts_approved","AVG(highest_likes) as average_likes","MAX(end_time) as last_scan_time"]).first(),b=await this.getScanConfig(),c=b.lastScanTime?new Date(b.lastScanTime.getTime()+60*b.scanInterval*1e3):void 0,d=parseInt(a?.total_scans||"0"),e=parseInt(a?.total_posts_processed||"0"),f=parseInt(a?.total_posts_approved||"0");return{totalScans:d,totalPostsFound:parseInt(a?.total_posts_found||"0"),totalPostsProcessed:e,totalPostsApproved:f,averageLikes:parseFloat(a?.average_likes||"0"),topHashtags:[],topAccounts:[],scanFrequency:b.scanInterval,lastScanTime:a?.last_scan_time?new Date(a.last_scan_time):void 0,nextScanTime:c,successRate:e>0?f/e*100:0}}catch(a){return{totalScans:0,totalPostsFound:0,totalPostsProcessed:0,totalPostsApproved:0,averageLikes:0,topHashtags:[],topAccounts:[],scanFrequency:60,lastScanTime:void 0,nextScanTime:void 0,successRate:0}}}async testConnection(){try{let a=await this.instagramService.getApiStatus();if(a.isAuthenticated)return{success:!0,message:"Instagram API connection successful",details:a};return{success:!1,message:a.lastError||"Instagram not authenticated",details:a}}catch(a){return{success:!1,message:`Connection test failed: ${a.message}`,details:{error:a.message}}}}}let o=new n;d()}catch(a){d(a)}})}};