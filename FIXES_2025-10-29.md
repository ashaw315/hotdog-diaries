# Fixes Applied on 2025-10-29

## Summary
Fixed critical bugs preventing automated content posting. The system now has:
- ✅ All 6 daily time slots filled with content
- ✅ Correct `status='pending'` on all slots
- ✅ Fixed DST-aware timezone conversion
- ✅ Synchronized AUTH_TOKEN between GitHub and Vercel

## Issues Fixed

### 1. Missing `status` Column in `scheduled_posts` Table
**Problem**: Posting service queries `WHERE status = 'pending'`, but the column didn't exist.

**Fix**: Added `status` column with migration:
```sql
ALTER TABLE public.scheduled_posts
ADD COLUMN status TEXT NOT NULL DEFAULT 'pending'
CHECK (status IN ('pending', 'posting', 'posted', 'failed'));
```

**File**: `supabase/migrations/20251029_add_status_column.sql`

### 2. Refill Code Not Setting `status='pending'`
**Problem**: Refill was creating/updating rows without setting the status field.

**Fix**: Updated `lib/jobs/schedule-content-production.ts` to include `status: 'pending'` in:
- Supabase upsert (line 784)
- SQLite UPDATE (line 796)
- SQLite INSERT (line 813)

**Commits**:
- `9f9b682` - Add status field to upserts
- `391a1e5` - Only skip slots that have all three: content_id, scheduled_post_time, AND status='pending'

### 3. Broken Timezone Trigger in Database
**Problem**: The `set_scheduled_day()` trigger had double timezone conversion bug:
```sql
-- BUGGY VERSION:
(NEW.scheduled_post_time AT TIME ZONE 'UTC' AT TIME ZONE 'America/New_York')::date
```

This caused evening slots (18:00, 21:00, 23:30) to get wrong `scheduled_day` values.

**Example**:
- Time: `2025-10-30 01:00:00+00` (which is 21:00 ET on Oct 29)
- Bug result: `scheduled_day = '2025-10-30'` ❌
- Correct: `scheduled_day = '2025-10-29'` ✓

**Fix**: Corrected to single timezone conversion:
```sql
-- FIXED VERSION:
(NEW.scheduled_post_time AT TIME ZONE 'America/New_York')::date
```

**File**: `supabase/migrations/20251029_fix_scheduled_day_trigger.sql`

### 4. AUTH_TOKEN Mismatch Between GitHub and Vercel
**Problem**: GitHub Actions workflow was using different token than Vercel expected.

**Fix**: Generated new token and set in both places:
- GitHub Secrets: `AUTH_TOKEN = -i3tIXjxLqaO1zdHn3kcaUU9hyIz3_yBUVRgGWwEd0Y`
- Vercel Env Vars: `AUTH_TOKEN` and `CRON_SECRET` (both same value)

### 5. Database Column Name Mismatches
**Problem**: Code was using wrong column names:
- Using `scheduled_for` instead of `scheduled_post_time`
- Using `status` instead of `content_status` (in content_queue table)

**Fix**: Updated `app/api/admin/schedule/daily/route.ts` (20 changes)

**Commit**: `eba96a9` - Fix all database column name mismatches

## Current State (as of 12:43 PM ET, Oct 29, 2025)

### Database Status
All 6 slots for 2025-10-29 are correctly populated:

| Slot | Time  | Platform | Content ID | Status    | scheduled_day | scheduled_post_time        |
|------|-------|----------|------------|-----------|---------------|----------------------------|
| 0    | 08:00 | reddit   | 7797       | pending   | 2025-10-29    | 2025-10-29 12:00:00+00     |
| 1    | 12:00 | pixabay  | 64         | pending   | 2025-10-29    | 2025-10-29 16:00:00+00     |
| 2    | 15:00 | imgur    | 8508       | pending   | 2025-10-29    | 2025-10-29 19:00:00+00     |
| 3    | 18:00 | reddit   | 7800       | pending   | 2025-10-29    | 2025-10-29 22:00:00+00     |
| 4    | 21:00 | pixabay  | 91         | pending   | 2025-10-29    | 2025-10-30 01:00:00+00     |
| 5    | 23:30 | imgur    | 7862       | pending   | 2025-10-29    | 2025-10-30 03:30:00+00     |

### Admin UI Status
- ✅ Forecast shows all 6 slots with content
- ✅ Refill returns `kept: 6` (all slots complete)
- ⏳ Slots 0, 1 marked as "Missed" (times already passed)
- ⏳ Slot 2 (15:00) marked as "Upcoming" (next to post)

## Next Steps / Testing

### Immediate Test (3:00 PM ET today)
The GitHub Actions workflow runs hourly. At 3:05 PM ET:
1. Check if slot 2 (15:00, imgur, content_id 8508) was posted
2. Check Vercel logs for `/api/cron/post-scheduled`
3. Check if row was updated with `actual_posted_at` timestamp

### Potential Remaining Issue
The posting service (`lib/services/posting/schedule-only-poster.ts`) only supports SQLite, but production uses Supabase. This may prevent posting from working even though the data is correct.

**To verify**: Run this SQL at 3:00 PM to see if posting service can find the slot:
```sql
SELECT id, content_id, platform, status, scheduled_post_time
FROM scheduled_posts
WHERE status = 'pending'
  AND scheduled_post_time >= NOW() - INTERVAL '5 minutes'
  AND scheduled_post_time <= NOW() + INTERVAL '5 minutes';
```

If this returns the row but posting still doesn't work, the posting service needs to be updated to support Supabase.

## Files Changed

### Migrations
- `supabase/migrations/20251029_add_status_column.sql`
- `supabase/migrations/20251029_fix_scheduled_day_trigger.sql`

### Code Changes
- `lib/jobs/schedule-content-production.ts` - Add status field to all insert/update operations
- `app/api/admin/schedule/daily/route.ts` - Fix column name mismatches

### Documentation
- `RUN_THIS_IN_SUPABASE.sql` - Manual SQL to add status column
- `DELETE_AND_REFILL.sql` - SQL to clean corrupted rows
- `UPDATE_EXISTING_ROWS.sql` - SQL to diagnose row state

## Commits
- `b335cfb` - fix: resolve DST-aware timezone conversion bugs in scheduling system
- `eba96a9` - fix: fix all database column name mismatches
- `9f9b682` - fix: set status='pending' on all refill operations
- `391a1e5` - fix: only skip slots that have content_id, scheduled_post_time, AND status='pending'
- `d77663a` - feat: add status column migration
- `e44146b` - debug: add detailed logging to see existing row state
- `a65ae21` - docs: add SQL scripts to diagnose timezone-corrupted rows
- `eccb279` - fix: correct scheduled_day trigger to handle DST timezone conversion properly
