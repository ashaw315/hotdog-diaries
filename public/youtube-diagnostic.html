<!DOCTYPE html>
<html>
<head>
  <title>YouTube Embed Diagnostic</title>
  <style>
    body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #fff; }
    .test { margin: 20px 0; padding: 15px; border: 1px solid #333; background: #2a2a2a; }
    .pass { background: #1a3a1a; border-color: #0f0; }
    .fail { background: #3a1a1a; border-color: #f00; }
    .warning { background: #3a3a1a; border-color: #ff0; }
    .iframe-container { width: 560px; height: 315px; margin: 20px 0; }
    pre { background: #000; padding: 10px; overflow-x: auto; }
    .metric { display: inline-block; margin: 10px 20px 10px 0; }
  </style>
</head>
<body>
  <h1>üîç YouTube Embed Diagnostic Tool</h1>
  <div id="diagnostics"></div>

  <script>
    const diagnostics = {
      timestamp: new Date().toISOString(),
      tests: [],
      metrics: {
        corsErrors: [],
        networkFailures: [],
        consoleErrors: [],
        resources: [],
        timing: {}
      }
    };

    // Test 1: Check browser environment
    function testBrowserEnvironment() {
      const test = {
        name: 'Browser Environment',
        checks: []
      };

      test.checks.push({
        name: 'Origin',
        value: window.location.origin,
        status: window.location.origin.includes('localhost') ? 'warning' : 'pass',
        note: 'localhost origins often get rate-limited'
      });

      test.checks.push({
        name: 'Browser',
        value: navigator.userAgent.substring(0, 50) + '...',
        status: 'info'
      });

      test.checks.push({
        name: 'Third-party cookies',
        value: navigator.cookieEnabled ? 'Enabled' : 'Disabled',
        status: navigator.cookieEnabled ? 'pass' : 'fail',
        note: 'YouTube requires cookies for some features'
      });

      diagnostics.tests.push(test);
      return test;
    }

    // Test 2: Network connectivity to YouTube
    async function testYouTubeConnectivity() {
      const test = {
        name: 'YouTube Connectivity',
        checks: []
      };

      try {
        const start = performance.now();
        const response = await fetch('https://www.youtube.com/favicon.ico', { mode: 'no-cors' });
        const time = performance.now() - start;
        test.checks.push({
          name: 'YouTube.com accessible',
          value: `${time.toFixed(0)}ms`,
          status: 'pass'
        });
      } catch (e) {
        test.checks.push({
          name: 'YouTube.com accessible',
          value: e.message,
          status: 'fail'
        });
      }

      try {
        const response = await fetch('https://www.youtube-nocookie.com/favicon.ico', { mode: 'no-cors' });
        test.checks.push({
          name: 'YouTube-nocookie accessible',
          value: 'Yes',
          status: 'pass'
        });
      } catch (e) {
        test.checks.push({
          name: 'YouTube-nocookie accessible',
          value: 'No',
          status: 'warning'
        });
      }

      diagnostics.tests.push(test);
      return test;
    }

    // Test 3: Create actual embeds with different configurations
    function testEmbedConfigurations() {
      const test = {
        name: 'Embed Configurations',
        checks: []
      };

      const configs = [
        {
          name: 'Basic embed (no params)',
          url: 'https://www.youtube.com/embed/dQw4w9WgXcQ'
        },
        {
          name: 'With autoplay + mute',
          url: 'https://www.youtube.com/embed/dQw4w9WgXcQ?autoplay=1&mute=1'
        },
        {
          name: 'Privacy-enhanced mode',
          url: 'https://www.youtube-nocookie.com/embed/dQw4w9WgXcQ'
        },
        {
          name: 'With origin parameter',
          url: `https://www.youtube.com/embed/dQw4w9WgXcQ?origin=${window.location.origin}`
        },
        {
          name: 'With enablejsapi',
          url: 'https://www.youtube.com/embed/dQw4w9WgXcQ?enablejsapi=1'
        },
        {
          name: 'Minimal (only video ID)',
          url: 'https://www.youtube.com/embed/dQw4w9WgXcQ'
        }
      ];

      configs.forEach((config, index) => {
        const container = document.createElement('div');
        container.className = 'test';
        container.innerHTML = `
          <h3>Test: ${config.name}</h3>
          <div class="iframe-container">
            <iframe 
              id="embed-${index}"
              src="${config.url}"
              width="560" 
              height="315"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
              allowfullscreen>
            </iframe>
          </div>
          <div id="status-${index}">Loading...</div>
        `;
        document.body.appendChild(container);

        setTimeout(() => {
          const iframe = document.getElementById(`embed-${index}`);
          const status = document.getElementById(`status-${index}`);
          
          try {
            const iframeDoc = iframe.contentWindow.document;
            status.innerHTML = '‚ö†Ô∏è Loaded but no video access (expected)';
            status.className = 'warning';
          } catch (e) {
            status.innerHTML = '‚úÖ Iframe loaded (cross-origin protected)';
            status.className = 'pass';
          }

          test.checks.push({
            name: config.name,
            value: 'Check network tab for errors',
            status: 'info'
          });
        }, 3000);
      });

      diagnostics.tests.push(test);
      return test;
    }

    // Test 4: Monitor network requests
    function monitorNetwork() {
      const test = {
        name: 'Network Monitoring',
        checks: []
      };

      if (window.PerformanceObserver) {
        const observer = new PerformanceObserver((list) => {
          for (const entry of list.getEntries()) {
            diagnostics.metrics.resources.push({
              name: entry.name,
              duration: entry.duration,
              transferSize: entry.transferSize,
              type: entry.initiatorType
            });

            if (entry.transferSize === 0 && entry.name.includes('google')) {
              diagnostics.metrics.corsErrors.push(entry.name);
              test.checks.push({
                name: 'CORS Block detected',
                value: entry.name.substring(0, 50) + '...',
                status: 'fail'
              });
            }

            if (entry.name.includes('googlevideo.com')) {
              test.checks.push({
                name: 'Video request',
                value: `${entry.transferSize > 0 ? 'Success' : 'Failed'}`,
                status: entry.transferSize > 0 ? 'pass' : 'fail'
              });
            }
          }
        });
        observer.observe({ entryTypes: ['resource'] });
      }

      diagnostics.tests.push(test);
      return test;
    }

    // Test 5: Console error monitoring
    function monitorConsoleErrors() {
      const test = {
        name: 'Console Errors',
        checks: []
      };

      const originalError = console.error;
      console.error = function(...args) {
        const errorMsg = args.join(' ');
        diagnostics.metrics.consoleErrors.push(errorMsg);
        
        if (errorMsg.includes('CORS')) {
          test.checks.push({
            name: 'CORS Error',
            value: errorMsg.substring(0, 100) + '...',
            status: 'fail'
          });
        } else if (errorMsg.includes('YouTube')) {
          test.checks.push({
            name: 'YouTube Error',
            value: errorMsg.substring(0, 100) + '...',
            status: 'fail'
          });
        }
        
        originalError.apply(console, args);
      };

      window.addEventListener('error', (e) => {
        test.checks.push({
          name: 'Global Error',
          value: e.message,
          status: 'fail'
        });
      });

      diagnostics.tests.push(test);
      return test;
    }

    // Test 6: Check rate limiting
    async function testRateLimiting() {
      const test = {
        name: 'Rate Limiting Check',
        checks: []
      };

      try {
        const ytData = sessionStorage.getItem('yt-player-headers-readable');
        if (ytData) {
          test.checks.push({
            name: 'YouTube session data',
            value: 'Present',
            status: 'info'
          });
        }
      } catch (e) {}

      const loadCount = parseInt(localStorage.getItem('yt-load-count') || '0');
      localStorage.setItem('yt-load-count', (loadCount + 1).toString());
      
      test.checks.push({
        name: 'Page loads this session',
        value: loadCount + 1,
        status: loadCount > 10 ? 'warning' : 'pass',
        note: loadCount > 10 ? 'High load count may trigger rate limiting' : ''
      });

      diagnostics.tests.push(test);
      return test;
    }

    // Run all diagnostics
    async function runDiagnostics() {
      const output = document.getElementById('diagnostics');
      
      monitorConsoleErrors();
      monitorNetwork();
      
      testBrowserEnvironment();
      await testYouTubeConnectivity();
      testRateLimiting();
      
      setTimeout(() => {
        testEmbedConfigurations();
        setTimeout(generateReport, 5000);
      }, 1000);
    }

    // Generate final report
    function generateReport() {
      const output = document.getElementById('diagnostics');
      
      let html = '<h2>üìä Diagnostic Report</h2>';
      
      html += '<div class="test">';
      html += '<h3>Summary</h3>';
      html += `<div class="metric">CORS Errors: ${diagnostics.metrics.corsErrors.length}</div>`;
      html += `<div class="metric">Console Errors: ${diagnostics.metrics.consoleErrors.length}</div>`;
      html += `<div class="metric">Network Resources: ${diagnostics.metrics.resources.length}</div>`;
      html += '</div>';
      
      diagnostics.tests.forEach(test => {
        const hasFailures = test.checks.some(c => c.status === 'fail');
        const hasWarnings = test.checks.some(c => c.status === 'warning');
        
        html += `<div class="test ${hasFailures ? 'fail' : hasWarnings ? 'warning' : 'pass'}">`;
        html += `<h3>${test.name}</h3>`;
        
        test.checks.forEach(check => {
          const icon = check.status === 'pass' ? '‚úÖ' : 
                       check.status === 'fail' ? '‚ùå' : 
                       check.status === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
          html += `<div>${icon} ${check.name}: <strong>${check.value}</strong>`;
          if (check.note) html += ` <em>(${check.note})</em>`;
          html += '</div>';
        });
        
        html += '</div>';
      });
      
      html += '<div class="test">';
      html += '<h3>Raw Diagnostic Data</h3>';
      html += '<pre>' + JSON.stringify(diagnostics, null, 2) + '</pre>';
      html += '</div>';
      
      html += '<div class="test">';
      html += '<h3>üéØ Likely Issue</h3>';
      
      if (diagnostics.metrics.corsErrors.length > 0) {
        html += '<p>‚ùå <strong>CORS Policy Blocking:</strong> YouTube is blocking video playback from localhost.</p>';
        html += '<p>Solutions: Remove autoplay, use production domain, or use click-to-play pattern.</p>';
      } else if (diagnostics.metrics.consoleErrors.length > 0) {
        html += '<p>‚ö†Ô∏è <strong>JavaScript Errors:</strong> Check console for specific error messages.</p>';
      } else if (window.location.origin.includes('localhost')) {
        html += '<p>‚ö†Ô∏è <strong>Localhost Development:</strong> YouTube may rate-limit or block localhost embeds.</p>';
      } else {
        html += '<p>‚úÖ <strong>No obvious issues detected.</strong> Check Network tab for specifics.</p>';
      }
      
      html += '</div>';
      
      output.innerHTML = html + output.innerHTML;
    }

    runDiagnostics();
  </script>
</body>
</html>